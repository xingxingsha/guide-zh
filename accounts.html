<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Users and Accounts | Meteor 指南 中译本</title>
    <meta name="description" content="How to build user login functionality into a Meteor app. Let your users log in with passwords, Facebook, Google, GitHub, and more.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="../images/favicon.png" sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://guide-zh.ourmeteor.com">
    <meta property="og:title" content="Users and Accounts | Meteor 指南 中译本">
    <meta property="og:description" content="How to build user login functionality into a Meteor app. Let your users log in with passwords, Facebook, Google, GitHub, and more.">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@meteor">
    <meta name="twitter:title" content="Users and Accounts | Meteor 指南 中译本">
    <meta name="twitter:description" content="How to build user login functionality into a Meteor app. Let your users log in with passwords, Facebook, Google, GitHub, and more.">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content="" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/style/style.css">
  </head>
  <body class="">
    

<div class="sidebar">
  <div class="panel">
    <div class="panel-item logo">
      <a href="http://www.meteor.com/developers" title="Meteor Developers" target=_new >
        <img src="../images/icon-white.svg" alt="Meteor Developers">
        <span>Meteor Developers</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="http://www.meteor.com/tutorials" target=_new >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><g fill="#112B49"><circle cx="80.001" cy="80" r="3"/><path d="M75.73 85.723c.193-.183.316-.437.316-.723 0-.553-.447-1-1-1-.278 0-.528.114-.71.297l-.004-.004-50.9 50.875c-.18.18-.29.43-.29.707-.002.553.445 1 .998 1 .276 0 .526-.112.708-.293l50.883-50.86zM84.235 74.4c-.18.183-.292.433-.292.71 0 .552.446 1 1 1 .275 0 .525-.113.707-.294l50.87-50.89c.204-.184.34-.442.34-.74 0-.552-.448-1-1-1-.276 0-.526.113-.707.294l-.01-.01L84.236 74.4zM136.583 135.184L85.65 84.23c-.182-.18-.432-.293-.708-.293-.552 0-1 .447-1 1 0 .278.114.528.297.71l50.927 50.95c.18.18.43.293.708.293.553 0 1-.447 1-1 0-.276-.11-.525-.292-.706zM111.19 152.602l-.003-.005-.002-.004-27.552-66.507h-.002c-.15-.362-.505-.617-.922-.617-.552 0-1 .446-1 1 0 .135.028.263.077.38v.002l.005.012 27.552 66.504c.15.362.507.617.924.617.553 0 1-.447 1-1 0-.136-.03-.265-.077-.383zM48.873 7.384L76.435 73.93h.002c.15.362.505.617.922.617.552 0 1-.447 1-1 0-.136-.03-.264-.078-.382h.003L50.72 6.616c-.15-.362-.506-.617-.923-.617-.552 0-1 .447-1 1 0 .136.03.265.078.383h-.002zM152.55 48.844h-.002L86.092 76.422c-.36.15-.617.507-.617.924 0 .553.446 1 1 1 .135 0 .265-.028.383-.077L153.32 50.69c.363-.15.618-.507.618-.924 0-.553-.447-1-1-1-.136 0-.265.028-.383.077h-.005zM7.41 111.136h.002l66.492-27.54c.36-.15.616-.507.616-.924 0-.553-.447-1-1-1-.136 0-.264.028-.382.077v-.002l-.004.002c-.002 0-.004 0-.006.002L6.638 109.29c-.36.15-.615.507-.615.924 0 .553.446 1 1 1 .135 0 .264-.028.382-.077h.004zM159 79H87c-.552 0-1 .448-1 1 0 .554.447 1 1 1h72c.553 0 1-.447 1-1s-.447-1-1-1zM23.435 24.85l50.897 50.897.008-.008c.182.18.43.29.707.29.553 0 1-.446 1-1 0-.296-.135-.555-.34-.737L24.85 23.433c-.183-.18-.433-.292-.71-.292-.55 0-.998.448-.998 1 0 .277.11.528.293.71zM6.618 50.657v.002l66.51 27.54c.003 0 .005 0 .007.002l.004.002c.117.048.245.076.38.076.554 0 1-.447 1-1 0-.417-.254-.772-.616-.923v-.002L7.392 48.813H7.39l-.005-.003c-.118-.047-.247-.076-.383-.076-.552 0-1 .447-1 1 0 .417.256.773.618.923zM153.383 109.28l-66.52-27.53-.006-.002c-.118-.048-.248-.076-.384-.076-.552 0-1 .447-1 1 0 .417.256.773.62.923l66.513 27.528c.003 0 .005 0 .007.002l.004.002c.118.048.246.076.382.076.552 0 1-.447 1-1 0-.417-.256-.772-.617-.923zM80 74c.553 0 1-.447 1-1V1c0-.553-.447-1-1-1-.552 0-1 .447-1 1v72c0 .553.447 1 1 1zM80 86c-.552 0-1 .447-1 1v72c0 .553.447 1 1 1s1-.447 1-1V87c0-.553-.447-1-1-1zM77.36 85.47c-.417 0-.772.254-.923.616l-27.564 66.53.002.002c-.05.117-.077.246-.077.382 0 .553.446 1 1 1 .416 0 .772-.255.922-.618h.002L78.28 86.86v-.004l.003-.005c.048-.117.076-.246.076-.382 0-.552-.448-1-1-1zM82.708 74.547c.417 0 .772-.255.923-.618h.003l27.56-66.547h-.004c.048-.12.076-.247.076-.383 0-.553-.447-1-1-1-.416 0-.772.255-.922.618h-.002l-27.56 66.546h.004c-.05.12-.077.247-.077.383-.002.553.445 1 .998 1zM74 80c0-.552-.446-1-1-1H1c-.552 0-1 .447-1 1 0 .553.447 1 1 1h72c.554 0 1-.446 1-1z"/></g></svg>
          <span>教程</span>
        </a>
      </div>
    
      <div class="panel-item active"">
        <a class="" href="http://guide.meteor.com"  >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#BDA671" d="M80 1.988c43.01 0 78 34.99 78 78s-34.99 78-78 78-78-34.99-78-78 34.99-78 78-78m0-2c-44.183 0-80 35.817-80 80s35.817 80 80 80 80-35.817 80-80-35.817-80-80-80z"/><path fill="#BDA671" d="M126.454 33.545l-37.93 54.98-54.98 37.93 37.93-54.98 54.98-37.93m0-2c-.395 0-.79.116-1.135.354L70.336 69.826c-.2.138-.373.312-.51.51l-37.93 54.98c-.548.796-.45 1.868.232 2.55.386.388.898.587 1.414.587.395 0 .79-.116 1.135-.354l54.98-37.93c.2-.137.373-.31.51-.51l37.93-54.98c.548-.795.45-1.867-.232-2.55-.387-.386-.9-.585-1.414-.585z"/><circle fill="#BDA671" cx="79.999" cy="79.999" r="2.999"/><path fill="#BDA671" d="M135.477 50.182c-.02-.036-.04-.05-.06-.045-.173-.303-.485-.516-.858-.516-.553 0-1 .448-1 1 0 .21.078.394.188.554l-.02.007C138.358 59.766 141 69.57 141 79.99c0 33.636-27.364 61-61 61-10.42 0-20.232-2.634-28.82-7.26l-.005.02c-.144-.08-.3-.14-.478-.14-.552 0-1 .448-1 1 0 .336.176.618.43.8-.016.012-.034.025-.03.027 8.896 4.81 19.078 7.552 29.904 7.552 34.795 0 63-28.206 63-63 0-10.79-2.735-20.93-7.523-29.805zM109.65 24.47c-.002-.02.004-.04-.025-.056-8.83-4.727-18.908-7.426-29.625-7.426-34.794 0-63 28.206-63 63 0 10.79 2.73 20.935 7.514 29.81.005.01.012.004.018.01.17.312.488.532.87.532.552 0 1-.447 1-1 0-.197-.073-.37-.17-.525l.04-.002C21.642 100.223 19 90.41 19 79.988c0-33.636 27.364-61 61-61 10.4 0 20.185 2.634 28.757 7.248.02.01.036.02.055.028.116.047.24.075.37.075.554 0 1-.448 1-1 .002-.382-.22-.7-.533-.87z"/></svg>
          <span>指南</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://docs.meteor.com"  >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#DE4F4F" d="M35.6 30.167v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375H80c.552 0 1 .447 1 1v10.873c1.162.413 2 1.51 2 2.816 0 1.657-1.343 3-3 3s-3-1.343-3-3c0-1.305.837-2.402 2-2.815v-9.873H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1s.448-1 1-1h90.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6zM138 6.564H22c-1.104 0-2 .896-2 2v144c0 1.104.896 2 2 2h48.995c.258 0 .516-.097.712-.293.39-.39.39-1.022 0-1.413-.195-.195-.45-.293-.707-.293H22v-144h116v144H89.006c-.258 0-.517.097-.713.293-.39.39-.39 1.023 0 1.414.196.198.455.294.713.293H138c1.104 0 2-.895 2-2v-144c0-1.103-.896-2-2-2z"/></svg>
          <span>API 文档</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="https://forums.meteor.com/" target=_new >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#333" d="M60.025 17.72c7.396 0 14.914 1.424 22.172 4.43 29.594 12.258 43.648 46.188 31.39 75.782-9.25 22.334-30.843 35.812-53.6 35.812-4.694 0-9.437-.574-14.132-1.76L32.44 142.277 30.23 125.51C5.908 111.003-4.74 80.48 6.418 53.538 15.67 31.204 37.266 17.72 60.025 17.72m0-2c-24.363 0-46.13 14.545-55.455 37.053-5.547 13.394-6.06 28.33-1.447 42.052 4.465 13.276 13.414 24.57 25.252 31.896l2.082 15.82c.092.708.557 1.31 1.217 1.585.246.104.506.152.766.152.434 0 .86-.142 1.217-.412l12.656-9.713c4.482 1.055 9.076 1.59 13.674 1.59 24.36 0 46.126-14.543 55.447-37.047 6.135-14.807 6.135-31.115.002-45.922C109.3 37.966 97.77 26.433 82.963 20.3c-7.34-3.04-15.06-4.58-22.938-4.58zM92.69 133.9c.165-.443.614-.683 1.064-.623l.004-.024c5.18.558 10.343.396 15.365-.414v2.034c-5.13.796-10.4.942-15.69.356l.002-.02c-.052-.01-.105-.006-.158-.023-.517-.193-.78-.768-.586-1.287z"/><path fill="#333" d="M100.877 133.604c4.41-.065 8.86-.633 13.268-1.746l13.416 10.295 2.208-16.77c24.324-14.505 34.976-45.03 23.814-71.97-9.248-22.33-30.832-35.81-53.584-35.82v.02c-2.072-.002-4.154.096-6.238.32l-.004-.024c-.45.058-.9-.18-1.064-.625-.194-.518.068-1.093.586-1.286.054-.02.107-.015.158-.026l-.002-.02c2.19-.24 4.377-.348 6.553-.35v-.01c24.36.004 46.12 14.545 55.443 37.054 5.55 13.393 6.062 28.327 1.447 42.05-4.465 13.28-13.414 24.57-25.252 31.897l-2.082 15.818c-.092.71-.557 1.312-1.217 1.586-.246.103-.506.15-.766.15-.435 0-.86-.14-1.218-.412l-12.655-9.713c-4.2.988-8.502 1.502-12.812 1.564l.002-1.986z"/><circle fill="#333" cx="60.019" cy="77" r="3.001"/><circle fill="#333" cx="76.018" cy="77" r="3"/><circle fill="#333" cx="44.019" cy="77" r="3.001"/></svg>

          <span>论坛</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Meteor 指南 中译本</span>
      
        <span class="select version-sidebar nochrome">
          <select class="version-select">
            
              <option value="v1.3">1.3</option>
            
              <option value="v1.2">1.2</option>
            
          </select>
        </span>
      
    </div>

    
    <div class="wrapper-search">
      <div class="input-symbol small round">
        <input type="text" placeholder="Search 官方指南" id="desktop-search-input" />
        <span class="icon-search"></span>
      </div>
      <div class="wrapper-desktop-search-results"></div>
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="index.html" class="sidebar-link ">
                  <span>介绍</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="code-style.html" class="sidebar-link ">
                  <span>编码风格</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="structure.html" class="sidebar-link ">
                  <span>Application Structure</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="1.3-migration.html" class="sidebar-link ">
                  <span>Migrating to Meteor 1.3</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">数据</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="collections.html" class="sidebar-link ">
                  <span>数据集与数据结构</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="data-loading.html" class="sidebar-link ">
                  <span>Publications and Data Loading</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="methods.html" class="sidebar-link ">
                  <span>Methods</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Users and Accounts</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="testing.html" class="sidebar-link ">
                  <span>Testing</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">视图</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="routing.html" class="sidebar-link ">
                  <span>URL 和路由</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="ui-ux.html" class="sidebar-link ">
                  <span>User Interfaces</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="blaze.html" class="sidebar-link ">
                  <span>Blaze</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="react.html" class="sidebar-link ">
                  <span>React</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="angular.html" class="sidebar-link ">
                  <span>Angular</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">构建</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="atmosphere-vs-npm.html" class="sidebar-link ">
                  <span>Atmosphere vs. npm</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="using-atmosphere-packages.html" class="sidebar-link ">
                  <span>Using Atmosphere Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="writing-atmosphere-packages.html" class="sidebar-link ">
                  <span>Writing Atmosphere Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="using-npm-packages.html" class="sidebar-link ">
                  <span>Using npm Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="writing-npm-packages.html" class="sidebar-link ">
                  <span>Writing npm Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="mobile.html" class="sidebar-link ">
                  <span>Mobile</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="build-tool.html" class="sidebar-link ">
                  <span>Build System</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">生产环境</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="security.html" class="sidebar-link ">
                  <span>Security</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="deployment.html" class="sidebar-link ">
                  <span>Deployment and Monitoring</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">有关本指南</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="CONTRIBUTING.html" class="sidebar-link ">
                  <span>Contribution Guidelines</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="CHANGELOG.html" class="sidebar-link ">
                  <span>Changelog</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>


<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item">
      <span class="js-sidebar-toggle">
        <span class="icon-menu"></span>
      </span>
    </div>
  </div>

  <div class="center-wrapper">
    <img src="../images/logo-coralspace.svg" alt="Meteor 指南 中译本"/>
    <div>官方指南</div>
  </div>

  
  <div class="nav-group right">
    <div class="nav-item">
      <span class="js-search-toggle">
        <span class="icon-search"></span>
      </span>
    </div>
  </div>

  <div class="nav-search">
    <div class="input-symbol">
      <input type="text" placeholder="Search 官方指南" id="mobile-search-input"/>
      <span class="icon-search"></span>
    </div>

    <div class="nav-group right">
      <div class="nav-item">
        <span class="js-search-toggle">
          <span class="icon-close"></span>
        </span>
      </div>
    </div>
    
    <div class="wrapper-mobile-search-results"></div>
  </div>
  
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Users and Accounts</h1>
      
        <div class="subtitle-page">How to build user login functionality into a Meteor app. Let your users log in with passwords, Facebook, Google, GitHub, and more.</div>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn primary small round lowercase" href="https://github.com/ourmeteor/guide-zh/tree/master/content/accounts.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
            <a class="btn tertiary small round lowercase" href="https://forums.meteor.com/t/19664"><span class="icon-comment"></span> <span>Discuss</span></a>
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <p>After reading this article, you’ll know:</p>
<ol>
<li>What features in core Meteor enable user accounts</li>
<li>How to use accounts-ui for a quick prototype</li>
<li>How to use the useraccounts family of packages to build your login UI</li>
<li>How to build a fully-featured password login experience</li>
<li>How to enable login through OAuth providers like Facebook</li>
<li>How to add custom data to Meteor’s users collection</li>
<li>How to manage user roles and permissions</li>
</ol>
<h2 id="core-meteor">Features in core Meteor</h2>

<p>Before we get into all of the different user-facing accounts functionality you can add with Meteor, let’s go over some of the features built into the Meteor DDP protocol and <code>accounts-base</code> package. These are the parts of Meteor that you’ll definitely need to be aware of if you have any user accounts in your app; most of everything else is optional and added/removed via packages.</p>
<h3 id="userid-ddp">userId in DDP</h3>

<p>DDP is Meteor’s built-in pub/sub and RPC protocol. You can read about how to use it in the <a href="data-loading.html">Data Loading</a> and <a href="methods.html">Methods</a> articles. In addition to the concepts of data loading and method calls, DDP has one more feature built in - the idea of a <code>userId</code> field on a connection. This is the place where login state is tracked, regardless of which accounts UI package or login service you are using.</p>
<p>This built-in feature means that you always get <code>this.userId</code> inside Methods and Publications, and can access the user ID on the client. This is a great starting point for building your own custom accounts system, but most developers won’t need to worry about the mechanics, since you’ll mostly be interacting with the <code>accounts-base</code> package instead.</p>
<h3 id="accounts-base"><code>accounts-base</code></h3>

<p>This package is the core of Meteor’s developer-facing user accounts functionality. This includes:</p>
<ol>
<li>A users collection with a standard schema, accessed through <a href="http://docs.meteor.com/#/full/meteor_users" target="_blank" rel="external"><code>Meteor.users</code></a>, and the client-side singletons <a href="http://docs.meteor.com/#/full/meteor_userid" target="_blank" rel="external"><code>Meteor.userId()</code></a> and <a href="http://docs.meteor.com/#/full/meteor_user" target="_blank" rel="external"><code>Meteor.user()</code></a>, which represent the login state on the client.</li>
<li>A variety of helpful other generic methods to keep track of login state, log out, validate users, etc. Visit the <a href="http://docs.meteor.com/#/full/accounts_api" target="_blank" rel="external">Accounts section of the docs</a> to find a complete list.</li>
<li>An API for registering new login handlers, which is used by all of the other accounts packages to integrate with the accounts system. There isn’t any official documentation for this API, but you can <a href="https://meteorhacks.com/extending-meteor-accounts" target="_blank" rel="external">read more about it on the MeteorHacks blog</a>.</li>
</ol>
<p>Usually, you don’t need to include <code>accounts-base</code> yourself since it’s added for you if you use <code>accounts-password</code> or similar, but it’s good to be aware of what is what.</p>
<h2 id="accounts-ui">Fast prototyping with <code>accounts-ui</code></h2>

<p>Often, a complicated accounts system is not the first thing you want to build when you’re starting out with a new app, so it’s useful to have something you can just drop in quickly. This is where <code>accounts-ui</code> comes in - it’s just one line that you drop into your app to get an accounts system. To add it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meteor add accounts-ui</span><br></pre></td></tr></table></figure>
<p>Then just include it anywhere in a Blaze template:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&gt; loginButtons&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>Then, make sure to pick a login provider; they will automatically integrate with <code>accounts-ui</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pick one or more of the below</span></span><br><span class="line">meteor add accounts-password</span><br><span class="line">meteor add accounts-facebook</span><br><span class="line">meteor add accounts-google</span><br><span class="line">meteor add accounts-github</span><br><span class="line">meteor add accounts-twitter</span><br><span class="line">meteor add accounts-meetup</span><br><span class="line">meteor add accounts-meteor-developer</span><br></pre></td></tr></table></figure>
<p>Now just open your app, follow the configuration steps, and you’re good to go - if you’ve done the <a href="https://www.meteor.com/tutorials/blaze/adding-user-accounts" target="_blank" rel="external">Meteor tutorial</a>, you’ve already seen this in action. Of course, in a production application, you probably want a more custom user interface and some logic to have a more tailored UX, but that’s why we have the rest of this guide.</p>
<p>Here are a couple of screenshots of <code>accounts-ui</code> so you know what to expect:</p>
<p><img src="images/accounts-ui.png"></p>
<h2 id="useraccounts">Customizable UI: useraccounts</h2>

<p>Once you’ve gotten your initial prototype up and running with <code>accounts-ui</code>, you’ll want to move to something more powerful and configurable so that you can better integrate your login flow with the rest of your app. The <a href="http://useraccounts.meteor.com/" target="_blank" rel="external"><code>useraccounts</code> family of packages</a> is the most powerful set of accounts management UI controls available for Meteor today. If you need even more customization, you can also roll your own system, but it’s worth trying <code>useraccounts</code> first.</p>
<h3 id="useraccounts-flexibility">Use any router or UI framework</h3>

<p>The first thing to understand about <code>useraccounts</code> is that the core accounts management logic is independent of the HTML templates and routing packages. This means you can use <a href="https://atmospherejs.com/useraccounts/core" target="_blank" rel="external"><code>useraccounts:core</code></a> to build your own set of login templates. Generally, you’ll want to pick one login template package and one login routing package. The options for templates include:</p>
<ul>
<li><a href="https://atmospherejs.com/useraccounts/unstyled" target="_blank" rel="external"><code>useraccounts:unstyled</code></a> which lets you bring your own CSS; this one is used in the Todos example app to make the login UI blend seamlessly with the rest of the app.</li>
<li>Pre-built templates for <a href="http://useraccounts.meteor.com/" target="_blank" rel="external">Bootstrap, Semantic UI, Materialize, and more</a>. These templates don’t come with the actual CSS framework, so you can pick your favorite Bootstrap package, for example.</li>
</ul>
<p>While it’s optional and the basic functionality will work without it, it’s also a good idea to pick a router integration:</p>
<ul>
<li><a href="https://atmospherejs.com/useraccounts/flow-routing" target="_blank" rel="external">Flow Router</a>, the router <a href="routing.html">recommended in this guide</a>.</li>
<li><a href="https://atmospherejs.com/useraccounts/iron-routing" target="_blank" rel="external">Iron Router</a>, another popular router in the Meteor community.</li>
</ul>
<p>In the example app we are using the Flow Router integration with great success. Some of the later sections will cover how to customize the routes and templates to fit your app better.</p>
<h3 id="useraccounts-drop-in">Drop-in UI without routing</h3>

<p>If you don’t want to configure routing for your login flow, you can just drop in a self-managing accounts screen. Wherever you want the accounts UI template to render, just include the <code>atForm</code> template, like so:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&gt; atForm&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>Once you configure routing according to <a href="#useraccounts-customizing-routes">the section below</a>, you’ll want to remove this inclusion.</p>
<h3 id="useraccounts-customizing-templates">Customizing templates</h3>

<p>For some apps, the off-the-shelf login templates provided by the various <code>useraccounts</code> UI packages will work as-is, but most apps will want to customize some of the presentation. There’s a simple way to do that using the template replacement functionality of the <code>aldeed:template-extension</code> package.</p>
<p>First, figure out which template you want to replace by looking at the source code of the package. For example, in the <code>useraccounts:unstyled</code> package, the templates are listed <a href="https://github.com/meteor-useraccounts/unstyled/tree/master/lib" target="_blank" rel="external">in this directory on GitHub</a>. By squinting at the file names and looking for some of the HTML strings, we can figure out that we might be interested in replacing the <code>atPwdFormBtn</code> template. Let’s take a look at the original template:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"atPwdFormBtn"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"at-btn submit &#123;&#123;submitDisabled&#125;&#125;"</span> <span class="attr">id</span>=<span class="string">"at-btn"</span>&gt;</span></span><br><span class="line">    &#123;&#123;buttonText&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Once you’ve identified which template you need to replace, define a new template. In this case, we want to modify the class on the button to work with the CSS for the rest of the app. There are a few things to keep in mind when overriding a template:</p>
<ol>
<li>Render the helpers in the same way the previous template did. In this case we are using <code>buttonText</code>.</li>
<li>Keep any <code>id</code> attributes, like <code>at-btn</code>, since those are used for event handling.</li>
</ol>
<p>Here’s what our new override template looks like:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"override-atPwdFormBtn"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn-primary"</span> <span class="attr">id</span>=<span class="string">"at-btn"</span>&gt;</span></span><br><span class="line">    &#123;&#123;buttonText&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Then, use the <code>replaces</code> function on the template to override the existing template from <code>useraccounts</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Template[<span class="string">'override-atPwdFormBtn'</span>].replaces(<span class="string">'atPwdFormBtn'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="useraccounts-customizing-routes">Customizing routes</h3>

<p>In addition to having control over the templates, you’ll want to be able to control the routing and URLs for the different views offered by <code>useraccounts</code>. Since Flow Router is the officially recommended routing option for Meteor, we’ll go over that in particular.</p>
<p>First, we need to configure the layout we want to use when rendering the accounts templates:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AccountsTemplates.configure(&#123;</span><br><span class="line">  defaultTemplate: <span class="string">'Auth_page'</span>,</span><br><span class="line">  defaultLayout: <span class="string">'App_body'</span>,</span><br><span class="line">  defaultContentRegion: <span class="string">'main'</span>,</span><br><span class="line">  defaultLayoutRegions: &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>In this case, we want to use the <code>App_body</code> layout template for all of the accounts-related pages. This template has a content region called <code>main</code>. Now, let’s configure some routes:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define these routes in a file loaded on both client and server</span></span><br><span class="line">AccountsTemplates.configureRoute(<span class="string">'signIn'</span>, &#123;</span><br><span class="line">  name: <span class="string">'signin'</span>,</span><br><span class="line">  path: <span class="string">'/signin'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">AccountsTemplates.configureRoute(<span class="string">'signUp'</span>, &#123;</span><br><span class="line">  name: <span class="string">'join'</span>,</span><br><span class="line">  path: <span class="string">'/join'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">AccountsTemplates.configureRoute(<span class="string">'forgotPwd'</span>);</span><br><span class="line"></span><br><span class="line">AccountsTemplates.configureRoute(<span class="string">'resetPwd'</span>, &#123;</span><br><span class="line">  name: <span class="string">'resetPwd'</span>,</span><br><span class="line">  path: <span class="string">'/reset-password'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now, we can easily render links to our login page like so:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btns-group"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;pathFor 'signin'&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"btn-secondary"</span>&gt;</span>Sign In<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123;pathFor 'join'&#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"btn-secondary"</span>&gt;</span>Join<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Note that we have specified a password reset route. Normally, we would have to configure Meteor’s accounts system to send this route in password reset emails, but the <code>useraccounts:flow-routing</code> package does it for us. <a href="#email-flows">Read more about configuring email flows below.</a></p>
<p>You can find a complete list of different available routes in the <a href="https://github.com/meteor-useraccounts/flow-routing#routes" target="_blank" rel="external">documentation the <code>useraccounts:flow-routing</code></a>.</p>
<h3 id="useraccounts-further-customization">Further customization</h3>

<p><code>useraccounts</code> offers many other customization options beyond templates and routing. Read the <a href="https://github.com/meteor-useraccounts/core/blob/master/Guide.md" target="_blank" rel="external"><code>useraccounts</code> guide</a> to learn about all of the other options.</p>
<h2 id="accounts-password">Password login</h2>

<p>Meteor comes with a secure and fully-featured password login system out of the box. To use it, add the package:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meteor add accounts-password</span><br></pre></td></tr></table></figure>
<p>To see what options are available to you, read the complete description of the <a href="http://docs.meteor.com/#/full/accounts_passwords" target="_blank" rel="external"><code>accounts-password</code> API in the Meteor docs</a>.</p>
<h3 id="requiring-username-email">Requiring username or email</h3>

<blockquote>
<p>Note: You don’t have to do this if you’re using <code>useraccounts</code>. It disables the regular Meteor client-side account creation functions for you and does custom validation.</p>
</blockquote>
<p>By default, the <code>Accounts.createUser</code> function provided by <code>accounts-password</code> allows you to create an account with a username, email, or both. Most apps expect a specific combination of the two, so you will certainly want to validate the new user creation:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Ensuring every user has an email address, should be in server-side code</span></span><br><span class="line">Accounts.validateNewUser((user) =&gt; &#123;</span><br><span class="line">  <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">    _id: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">    emails: &#123; type: <span class="built_in">Array</span> &#125;,</span><br><span class="line">    <span class="string">'emails.$'</span>: &#123; type: <span class="built_in">Object</span> &#125;,</span><br><span class="line">    <span class="string">'emails.$.address'</span>: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">    <span class="string">'emails.$.verified'</span>: &#123; type: <span class="built_in">Boolean</span> &#125;,</span><br><span class="line">    createdAt: &#123; type: <span class="built_in">Date</span> &#125;,</span><br><span class="line">    services: &#123; type: <span class="built_in">Object</span>, blackbox: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;).validate(user);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return true to allow user creation to proceed</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="multiple-emails">Multiple emails</h3>

<p>Often, users might want to associate multiple email addresses with the same account. <code>accounts-password</code> addresses this case by storing the email addresses as an array in the user collection. There are some handy API methods to deal with <a href="http://docs.meteor.com/#/full/Accounts-addEmail" target="_blank" rel="external">adding</a>, <a href="http://docs.meteor.com/#/full/Accounts-removeEmail" target="_blank" rel="external">removing</a>, and <a href="http://docs.meteor.com/#/full/accounts_verifyemail" target="_blank" rel="external">verifying</a> emails.</p>
<p>One useful thing to add for your app can be the concept of a “primary” email address. This way, if the user has added multiple emails, you know where to send confirmation emails and similar.</p>
<h3 id="case-sensitivity">Case sensitivity</h3>

<p>Before Meteor 1.2, all email addresses and usernames in the database were considered to be case-sensitive. This meant that if you registered an account as <code>AdaLovelace@example.com</code>, and then tried to log in with <code>adalovelace@example.com</code>, you’d see an error indicating that no user with that email exists. Of course, this can be quite confusing, so we decided to improve things in Meteor 1.2. But the situation was not as simple as it seemed; since MongoDB doesn’t have a concept of case-insensitive indexes, it was impossible to guarantee unique emails at the database level. For this reason, we have some special APIs for querying and updating users which manage the case-sensitivity problem at the application level.</p>
<h4 id="case-sensitivity-in-my-app">What does this mean for my app?</h4>

<p>Just follow one simple rule: don’t query the database by <code>username</code> or <code>email</code> directly. Instead, use the <a href="http://docs.meteor.com/#/full/Accounts-findUserByUsername" target="_blank" rel="external"><code>Accounts.findUserByUsername</code></a> and <a href="http://docs.meteor.com/#/full/Accounts-findUserByEmail" target="_blank" rel="external"><code>Accounts.findUserByEmail</code></a> methods provided by Meteor. This will run a query for you that is case-insensitive, so you will always find the user you are looking for.</p>
<h3 id="email-flows">Email flows</h3>

<p>When you have a login system for your app based on user emails, that opens up the possibility for email-based account flows. The common thing between all of these workflows is that they involve sending a unique link to the user’s email address, which does something special when it is clicked. Let’s look at some common examples that Meteor’s <code>accounts-password</code> package supports out of the box:</p>
<ol>
<li><strong>Password reset.</strong> When the user clicks the link in their email, they are taken to a page where they can enter a new password for their account.</li>
<li><strong>User enrollment.</strong> A new user is created by an administrator, but no password is set. When the user clicks the link in their email, they are taken to a page where they can set a new password for their account. Very similar to password reset.</li>
<li><strong>Email verification.</strong> When the user clicks the link in their email, the application records that this email does indeed belong to the correct user.</li>
</ol>
<p>Here, we’ll talk about how to manage the whole process manually from start to finish.</p>
<h4 id="default-email-flow">Email works out of the box with accounts UI packages</h4>

<p>If you want something that just works out of the box, you can use <code>accounts-ui</code> or <code>useraccounts</code> which basically do everything for you. Only follow the directions below if you definitely want to build all parts of the email flow yourself.</p>
<h4 id="sending-email">Sending the email</h4>

<p><code>accounts-password</code> comes with handy functions that you can call from the server to send an email. They are named for exactly what they do:</p>
<ol>
<li><a href="http://docs.meteor.com/#/full/accounts_sendresetpasswordemail" target="_blank" rel="external"><code>Accounts.sendResetPasswordEmail</code></a></li>
<li><a href="http://docs.meteor.com/#/full/accounts_sendenrollmentemail" target="_blank" rel="external"><code>Accounts.sendEnrollmentEmail</code></a></li>
<li><a href="http://docs.meteor.com/#/full/accounts_sendverificationemail" target="_blank" rel="external"><code>Accounts.sendVerificationEmail</code></a></li>
</ol>
<p>The email is generated using the email templates from <a href="http://docs.meteor.com/#/full/accounts_emailtemplates" target="_blank" rel="external">Accounts.emailTemplates</a>, and include links generated with <code>Accounts.urls</code>. We’ll go into more detail about customizing the email content and URL later.</p>
<h4 id="identifying-link-click">Identifying when the link is clicked</h4>

<p>When the user receives the email and clicks the link inside, their web browser will take them to your app. Now, you need to be able to identify these special links and act appropriately. If you haven’t customized the link URL, then you can use some built-in callbacks to identify when the app is in the middle of an email flow.</p>
<p>Normally, when the Meteor client connects to the server, the first thing it does is pass the <em>login resume token</em> to re-establish a previous login. However, when these callbacks from the email flow are triggered, the resume token is not sent until your code signals that it has finished handling the request by calling the <code>done</code> function that is passed into the registered callback. This means that if you were previously logged in as user A, and then you clicked the reset password link for user B, but then you cancelled the password reset flow by calling <code>done()</code>, the client would log in as A again.</p>
<ol>
<li><a href="http://docs.meteor.com/#/full/Accounts-onResetPasswordLink" target="_blank" rel="external"><code>Accounts.onResetPasswordLink</code></a></li>
<li><a href="http://docs.meteor.com/#/full/Accounts-onEnrollmentLink" target="_blank" rel="external"><code>Accounts.onEnrollmentLink</code></a></li>
<li><a href="http://docs.meteor.com/#/full/Accounts-onEmailVerificationLink" target="_blank" rel="external"><code>Accounts.onEmailVerificationLink</code></a></li>
</ol>
<p>Here’s how you would use one of these functions:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Accounts.onResetPasswordLink((token, done) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Display the password reset UI, get the new password...</span></span><br><span class="line"></span><br><span class="line">  Accounts.resetPassword(token, newPassword, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="comment">// Display error</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Resume normal operation</span></span><br><span class="line">      done();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>If you want a different URL for your reset password page, you need to customize it using the <code>Accounts.urls</code> option:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Accounts.urls.resetPassword = (token) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> Meteor.absoluteUrl(<span class="string">`reset-password/<span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If you have customized the URL, you will need to add a new route to your router that handles the URL you have specified, and the default <code>Accounts.onResetPasswordLink</code> and friends won’t work for you.</p>
<h4 id="completing-email-flow">Displaying an appropriate UI and completing the process</h4>

<p>Now that you know that the user is attempting to reset their password, set an initial password, or verify their email, you should display an appropriate UI to allow them to do so. For example, you might want to show a page with a form for the user to enter their new password.</p>
<p>When the user submits the form, you need to call the appropriate function to commit their change to the database. Each of these functions takes the new value and the token you got from the event in the previous step.</p>
<ol>
<li><a href="http://docs.meteor.com/#/full/accounts_resetpassword" target="_blank" rel="external"><code>Accounts.resetPassword</code></a> - this one should be used both for resetting the password, and enrolling a new user; it accepts both kinds of tokens.</li>
<li><a href="http://docs.meteor.com/#/full/accounts_verifyemail" target="_blank" rel="external"><code>Accounts.verifyEmail</code></a></li>
</ol>
<p>After you have called one of the two functions above or the user has cancelled the process, call the <code>done</code> function you got in the link callback. This will tell Meteor to get out of the special state it enters when you’re doing one of the email account flows.</p>
<h3 id="customizing-emails">Customizing accounts emails</h3>

<p>You will probably want to customize the emails <code>accounts-password</code> will send on your behalf. This can be easily done through the <a href="http://docs.meteor.com/#/full/accounts_emailtemplates" target="_blank" rel="external"><code>Accounts.emailTemplates</code> API</a>. Below is some example code from the Todos app:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Accounts.emailTemplates.siteName = <span class="string">"Meteor Guide Todos Example"</span>;</span><br><span class="line">Accounts.emailTemplates.from = <span class="string">"Meteor Todos Accounts &lt;accounts@example.com&gt;"</span>;</span><br><span class="line"></span><br><span class="line">Accounts.emailTemplates.resetPassword = &#123;</span><br><span class="line">  subject(user) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Reset your password on Meteor Todos"</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  text(user, url) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`Hello!</span><br><span class="line">Click the link below to reset your password on Meteor Todos.</span><br><span class="line"><span class="subst">$&#123;url&#125;</span></span><br><span class="line">If you didn't request this email, please ignore it.</span><br><span class="line">Thanks,</span><br><span class="line">The Meteor Todos team</span><br><span class="line">`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  html(user, url) &#123;</span><br><span class="line">    <span class="comment">// This is where HTML email content would go.</span></span><br><span class="line">    <span class="comment">// See the section about html emails below.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>As you can see, we can use the ES2015 template string functionality to generate a multi-line string that includes the password reset URL. We can also set a custom <code>from</code> address and email subject.</p>
<h4 id="html-emails">HTML emails</h4>

<p>If you’ve ever needed to deal with sending pretty HTML emails from an app, you know that it can quickly become a nightmare. Compatibility of popular email clients with basic HTML features like CSS is notoriously spotty, so it is hard to author something that works at all. Start with a <a href="https://github.com/leemunroe/responsive-html-email-template" target="_blank" rel="external">responsive email template</a> or <a href="http://foundation.zurb.com/emails/email-templates.html" target="_blank" rel="external">framework</a>, and then use a tool to convert your email content into something that is compatible with all email clients. <a href="http://blog.mailgun.com/transactional-html-email-templates/" target="_blank" rel="external">This blog post by Mailgun covers some of the main issues with HTML email.</a> In theory, a community package could extend Meteor’s build system to do the email compilation for you, but at the time of writing we were not aware of any such packages.</p>
<h2 id="oauth">OAuth login</h2>

<p>In the distant past, it could have been a huge headache to get Facebook or Google login to work with your app. Thankfully, most popular login providers have standardized around some version of <a href="https://en.wikipedia.org/wiki/OAuth" target="_blank" rel="external">OAuth</a>, and Meteor supports some of the most popular login services out of the box.</p>
<h3 id="supported-login-services">Facebook, Google, and more</h3>

<p>Here’s a complete list of login providers for which Meteor actively maintains core packages:</p>
<ol>
<li>Facebook with <code>accounts-facebook</code></li>
<li>Google with <code>accounts-google</code></li>
<li>GitHub with <code>accounts-github</code></li>
<li>Twitter with <code>accounts-twitter</code></li>
<li>Meetup with <code>accounts-meetup</code></li>
<li>Meteor Developer Accounts with <code>accounts-meteor-developer</code></li>
</ol>
<p>There is a package for logging in with Weibo, but it is no longer being actively maintained.</p>
<h3 id="oauth-logging-in">Logging in</h3>

<p>If you are using an off-the-shelf login UI like <code>accounts-ui</code> or <code>useraccounts</code>, you don’t need to write any code after adding the relevant package from the list above. If you are building a login experience from scratch, you can log in programmatically using the <a href="http://docs.meteor.com/#/full/meteor_loginwithexternalservice" target="_blank" rel="external"><code>Meteor.loginWith&lt;Service&gt;</code></a> function. It looks like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Meteor.loginWithFacebook(&#123;</span><br><span class="line">  requestPermissions: [<span class="string">'user_friends'</span>, <span class="string">'public_profile'</span>, <span class="string">'email'</span>]</span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// successful login!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="oauth-configuration">Configuring OAuth</h3>

<p>There are a few points to know about configuring OAuth login:</p>
<ol>
<li><strong>Client ID and secret.</strong> It’s best to keep your OAuth secret keys outside of your source code, and pass them in through Meteor.settings. Read how in the <a href="security.html#api-keys-oauth">Security article</a>.</li>
<li><strong>Redirect URL.</strong> On the OAuth provider’s side, you’ll need to specify a <em>redirect URL</em>. The URL will look like: <code>https://www.example.com/_oauth/facebook</code>. Replace <code>facebook</code> with the name of the service you are using. Note that you will need to configure two URLs - one for your production app, and one for your development environment, where the URL might be something like <code>http://localhost:3000/_oauth/facebook</code>.</li>
<li><strong>Permissions.</strong> Each login service provider should have documentation about which permissions are available. For example, <a href="https://developers.facebook.com/docs/facebook-login/permissions" target="_blank" rel="external">here is the page for Facebook</a>. If you want additional permissions to the user’s data when they log in, pass some of these strings in the <code>requestPermissions</code> option to <code>Meteor.loginWithFacebook</code> or <a href="http://docs.meteor.com/#/full/accounts_ui_config" target="_blank" rel="external"><code>Accounts.ui.config</code></a>. In the next section we’ll talk about how to retrieve that data.</li>
</ol>
<h3 id="oauth-calling-api">Calling service API for more data</h3>

<p>If your app supports or even requires login with an external service such as Facebook, it’s natural to also want to use that service’s API to request additional data about that user. For example, you might want to get a list of a Facebook user’s photos.</p>
<p>First, you’ll need to request the relevant permissions when logging in the user. See the <a href="#oauth-configuration">section above</a> for how to pass those options.</p>
<p>Then, you need to get the user’s access token. You can find this token in the <code>Meteor.users</code> collection under the <code>services</code> field. For example, if you wanted to get a particular user’s Facebook access token:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Given a userId, get the user's Facebook access token</span></span><br><span class="line"><span class="keyword">const</span> user = Meteor.users.findOne(userId);</span><br><span class="line"><span class="keyword">const</span> fbAccessToken = user.services.facebook.accessToken;</span><br></pre></td></tr></table></figure>
<p>For more details about the data stored in the user database, read the section below about accessing user data.</p>
<p>Now that you have the access token, you need to actually make a request to the appropriate API. Here you have two options:</p>
<ol>
<li>Use the <a href="http://docs.meteor.com/#/full/http" target="_blank" rel="external"><code>http</code> package</a> to access the service’s API directly. You’ll probably need to pass the access token from above in a header. For details you’ll need to search the API documentation for the service.</li>
<li>Use a package from Atmosphere or npm that wraps the API into a nice JavaScript interface. For example, if you’re trying to load data from Facebook you could use the <a href="https://www.npmjs.com/package/fbgraph" target="_blank" rel="external">fbgraph</a> npm package. Read more about how to use npm with your app in the <a href="build-tool.html#npm">Build System article</a>.</li>
</ol>
<h2 id="displaying-user-data">Loading and displaying user data</h2>

<p>Meteor’s accounts system, as implemented in <code>accounts-base</code>, also includes a database collection and generic functions for getting data about users.</p>
<h3 id="current-user">Currently logged in user</h3>

<p>Once a user is logged into your app with one of the methods described above, it is useful to be able to identify which user is logged in, and get the data provided during the registration process.</p>
<h4 id="current-user-client">On the client: Meteor.userId()</h4>

<p>For code that runs on the client, the global <code>Meteor.userId()</code> reactive function will give you the ID of the currently logged in user.</p>
<p>In addition to that core API, there are some helpful shorthand helpers: <code>Meteor.user()</code>, which is exactly equal to calling <code>Meteor.users.findOne(Meteor.userId())</code>, and the <code>{{currentUser}}</code> Blaze helper that returns the value of <code>Meteor.user()</code>.</p>
<p>Note that there is a benefit to restricting the places you access the current user to make your UI more testable and modular. Read more about this in the <a href="ui-ux.html#global-stores">UI article</a>.</p>
<h4 id="current-user-server">On the server: this.userId</h4>

<p>On the server, each connection has a different logged in user, so there is no global logged-in user state by definition. Since Meteor tracks the environment for each Method call, you can still use the <code>Meteor.userId()</code> global, which returns a different value depending on which Method you call it from, but you can run into edge cases when dealing with asynchronous code. Also, <code>Meteor.userId()</code> won’t work inside publications.</p>
<p>We suggest using the <code>this.userId</code> property on the context of Methods and publications instead, and passing that around through function arguments to wherever you need it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Accessing this.userId inside a publication</span></span><br><span class="line">Meteor.publish(<span class="string">'lists.private'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.userId) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.ready();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Lists.find(&#123;</span><br><span class="line">    userId: <span class="keyword">this</span>.userId</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    fields: Lists.publicFields</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Accessing this.userId inside a Method</span></span><br><span class="line">Meteor.methods(&#123;</span><br><span class="line">  <span class="string">'todos.updateText'</span>(&#123; todoId, newText &#125;) &#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">      todoId: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">      newText: &#123; type: <span class="built_in">String</span> &#125;</span><br><span class="line">    &#125;).validate(&#123; todoId, newText &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> todo = Todos.findOne(todoId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!todo.editableBy(<span class="keyword">this</span>.userId)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'todos.updateText.unauthorized'</span>,</span><br><span class="line">        <span class="string">'Cannot edit todos in a private list that is not yours'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Todos.update(todoId, &#123;</span><br><span class="line">      $set: &#123; text: newText &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="meteor-users-collection">The Meteor.users collection</h3>

<p>Meteor comes with a default MongoDB collection for user data. It’s stored in the database under the name <code>users</code>, and is accessible in your code through <code>Meteor.users</code>. The schema of a user document in this collection will depend on which login service was used to create the account. Here’s an example of a user that created their account with <code>accounts-password</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_id"</span>: <span class="string">"DQnDpEag2kPevSdJY"</span>,</span><br><span class="line">  <span class="string">"createdAt"</span>: <span class="string">"2015-12-10T22:34:17.610Z"</span>,</span><br><span class="line">  <span class="string">"services"</span>: &#123;</span><br><span class="line">    <span class="string">"password"</span>: &#123;</span><br><span class="line">      <span class="string">"bcrypt"</span>: <span class="string">"XXX"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"resume"</span>: &#123;</span><br><span class="line">      <span class="string">"loginTokens"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"when"</span>: <span class="string">"2015-12-10T22:34:17.615Z"</span>,</span><br><span class="line">          <span class="string">"hashedToken"</span>: <span class="string">"XXX"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"emails"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"address"</span>: <span class="string">"ada@lovelace.com"</span>,</span><br><span class="line">      <span class="string">"verified"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here’s what the same user would look like if they instead logged in with Facebook:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_id"</span>: <span class="string">"Ap85ac4r6Xe3paeAh"</span>,</span><br><span class="line">  <span class="string">"createdAt"</span>: <span class="string">"2015-12-10T22:29:46.854Z"</span>,</span><br><span class="line">  <span class="string">"services"</span>: &#123;</span><br><span class="line">    <span class="string">"facebook"</span>: &#123;</span><br><span class="line">      <span class="string">"accessToken"</span>: <span class="string">"XXX"</span>,</span><br><span class="line">      <span class="string">"expiresAt"</span>: <span class="number">1454970581716</span>,</span><br><span class="line">      <span class="string">"id"</span>: <span class="string">"XXX"</span>,</span><br><span class="line">      <span class="string">"email"</span>: <span class="string">"ada@lovelace.com"</span>,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Ada Lovelace"</span>,</span><br><span class="line">      <span class="string">"first_name"</span>: <span class="string">"Ada"</span>,</span><br><span class="line">      <span class="string">"last_name"</span>: <span class="string">"Lovelace"</span>,</span><br><span class="line">      <span class="string">"link"</span>: <span class="string">"https://www.facebook.com/app_scoped_user_id/XXX/"</span>,</span><br><span class="line">      <span class="string">"gender"</span>: <span class="string">"female"</span>,</span><br><span class="line">      <span class="string">"locale"</span>: <span class="string">"en_US"</span>,</span><br><span class="line">      <span class="string">"age_range"</span>: &#123;</span><br><span class="line">        <span class="string">"min"</span>: <span class="number">21</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"resume"</span>: &#123;</span><br><span class="line">      <span class="string">"loginTokens"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"when"</span>: <span class="string">"2015-12-10T22:29:46.858Z"</span>,</span><br><span class="line">          <span class="string">"hashedToken"</span>: <span class="string">"XXX"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"profile"</span>: &#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Sashko Stubailo"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that the schema is different when users register with different login services. There are a few things to be aware of when dealing with this collection:</p>
<ol>
<li>User documents in the database have secret data like access keys and hashed passwords. When <a href="#publish-custom-data">publishing user data to the client</a>, be extra careful not to include anything that client shouldn’t be able to see.</li>
<li>DDP, Meteor’s data publication protocol, only knows how to resolve conflicts in top-level fields. This means that you can’t have one publication send <code>services.facebook.first_name</code> and another send <code>services.facebook.locale</code> - one of them will win, and only one of the fields will actually be available on the client. The best way to fix this is to denormalize the data you want onto custom top-level fields, as described in the section about <a href="#custom-user-data">custom user data</a>.</li>
<li>The OAuth login service packages populate <code>profile.name</code>. We don’t recommend using this but, if you plan to, make sure to deny client-side writes to <code>profile</code>. See the section about the <a href="dont-use-profile"><code>profile</code> field on users</a>.</li>
<li>When finding users by email or username, make sure to use the case-insensitive functions provided by <code>accounts-password</code>. See the <a href="#case-sensitivity">section about case-sensitivity</a> for more details.</li>
</ol>
<h2 id="custom-user-data">Custom data about users</h2>

<p>As your app gets more complex, you will invariably need to store some data about individual users, and the most natural place to put that data is in additional fields on the <code>Meteor.users</code> collection described above. In a more normalized data situation it would be a good idea to keep Meteor’s user data and yours in two separate tables, but since MongoDB doesn’t deal well with data associations it makes sense to just use one collection.</p>
<h3 id="top-level-fields">Add top-level fields onto the user document</h3>

<p>The best way to store your custom data onto the <code>Meteor.users</code> collection is to add a new uniquely-named top-level field on the user document. For example, if you wanted to add a mailing address to a user, you could do it like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Using address schema from schema.org</span></span><br><span class="line"><span class="comment">// https://schema.org/PostalAddress</span></span><br><span class="line"><span class="keyword">const</span> newMailingAddress = &#123;</span><br><span class="line">  addressCountry: <span class="string">'US'</span>,</span><br><span class="line">  addressLocality: <span class="string">'Seattle'</span>,</span><br><span class="line">  addressRegion: <span class="string">'WA'</span>,</span><br><span class="line">  postalCode: <span class="string">'98052'</span>,</span><br><span class="line">  streetAddress: <span class="string">"20341 Whitworth Institute 405 N. Whitworth"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Meteor.users.update(userId, &#123;</span><br><span class="line">  $set: &#123;</span><br><span class="line">    mailingAddress: newMailingAddress</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="adding-fields-on-registration">Adding fields on user registration</h3>

<p>The code above is just code that you could run on the server inside a Meteor Method to set someone’s mailing address. Sometimes, you want to set a field when the user first creates their account, for example to initialize a default value or compute something from their social data. You can do this using <a href="http://docs.meteor.com/#/full/accounts_oncreateuser" target="_blank" rel="external"><code>Accounts.onCreateUser</code></a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate user initials after Facebook login</span></span><br><span class="line">Accounts.onCreateUser((options, user) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (! user.services.facebook) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected login with Facebook only.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; first_name, last_name &#125; = user.services.facebook;</span><br><span class="line">  user.initials = first_name[<span class="number">0</span>].toUpperCase() + last_name[<span class="number">0</span>].toUpperCase();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don't forget to return the new user object at the end!</span></span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Note that the <code>user</code> object provided doesn’t have an <code>_id</code> field yet. If you need to do something with the new user’s ID inside this function, a useful trick can be to generate the ID yourself:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate a todo list for each new user</span></span><br><span class="line">Accounts.onCreateUser((options, user) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Generate a user ID ourselves</span></span><br><span class="line">  user._id = Random.id(); <span class="comment">// Need to add the `random` package</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the user ID we generated</span></span><br><span class="line">  Lists.createListForUser(user._id);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don't forget to return the new user object at the end!</span></span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="dont-use-profile">Don’t use profile</h3>

<p>There’s a tempting existing field called <code>profile</code> that is added by default when a new user registers. This field was historically intended to be used as a scratch pad for user-specific data - maybe their image avatar, name, intro text, etc. Because of this, <strong>the <code>profile</code> field on every user is automatically writeable by that user from the client</strong>. It’s also automatically published to the client for that particular user.</p>
<p>It turns out that having a field writeable by default without making that super obvious might not be the best idea. There are many stories of new Meteor developers storing fields such as <code>isAdmin</code> on <code>profile</code>… and then a malicious user can easily set that to true whenever they want, making themselves an admin. Even if you aren’t concerned about this, it isn’t a good idea to let malicious users store arbitrary amounts of data in your database.</p>
<p>Rather than dealing with the specifics of this field, it can be helpful to just ignore its existence entirely. You can safely do that as long as you deny all writes from the client:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deny all client-side updates to user documents</span></span><br><span class="line">Meteor.users.deny(&#123;</span><br><span class="line">  update() &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Even ignoring the security implications of <code>profile</code>, it isn’t a good idea to put all of your app’s custom data onto one field. As discussed in the <a href="collections.html#schema-design">Collections article</a>, Meteor’s data transfer protocol doesn’t do deeply nested diffing of fields, so it’s a good idea to flatten out your objects into many top-level fields on the document.</p>
<h3 id="publish-custom-data">Publishing custom data</h3>

<p>If you want to access the custom data you’ve added to the <code>Meteor.users</code> collection in your UI, you’ll need to publish it to the client. Mostly, you can just follow the advice in the <a href="data-loading.html#publications">Data Loading</a> and <a href="security.html#publications">Security</a> articles.</p>
<p>The most important thing to keep in mind is that user documents are certain to contain private data about your users. In particular, the user document includes hashed password data and access keys for external APIs. This means it’s critically important to <a href="http://guide.meteor.com/security.html#fields" target="_blank" rel="external">filter the fields</a> of the user document that you send to any client.</p>
<p>Note that in Meteor’s publication and subscription system, it’s totally fine to publish the same document multiple times with different fields - they will get merged internally and the client will see a consistent document with all of the fields together. So if you just added one custom field, you should just write a publication with that one field. Let’s look at an example of how we might publish the <code>initials</code> field from above:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Meteor.publish(<span class="string">'Meteor.users.initials'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">&#123; userIds &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Validate the arguments to be what we expect</span></span><br><span class="line">  <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">    userIds: &#123; type: [<span class="built_in">String</span>] &#125;</span><br><span class="line">  &#125;).validate(&#123; userIds &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Select only the users that match the array of IDs passed in</span></span><br><span class="line">  <span class="keyword">const</span> selector = &#123;</span><br><span class="line">    _id: &#123; $<span class="keyword">in</span>: userIds &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only return one field, `initials`</span></span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    fields: &#123; initials: <span class="number">1</span> &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Meteor.users.find(selector, options);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This publication will let the client pass an array of user IDs it’s interested in, and get the initials for all of those users.</p>
<h2 id="roles-and-permissions">Roles and permissions</h2>

<p>One of the main reasons you might want to add a login system to your app is to have permissions for your data. For example, if you were running a forum, you would want administrators or moderators to be able to delete any post, but normal users can only delete their own. This uncovers two different types of permissions:</p>
<ol>
<li>Role-based permissions</li>
<li>Per-document permissions</li>
</ol>
<h3 id="alanning-roles">alanning:roles</h3>

<p>The most popular package for role-based permissions in Meteor is <a href="https://atmospherejs.com/alanning/roles" target="_blank" rel="external"><code>alanning:roles</code></a>. For example, here is how you would make a user into an administrator, or a moderator:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Give Alice the 'admin' role</span></span><br><span class="line">Roles.addUsersToRoles(aliceUserId, <span class="string">'admin'</span>, Roles.GLOBAL_GROUP);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Give Bob the 'moderator' role for a particular category</span></span><br><span class="line">Roles.addUsersToRoles(bobsUserId, <span class="string">'moderator'</span>, categoryId);</span><br></pre></td></tr></table></figure>
<p>Now, let’s say you wanted to check if someone was allowed to delete a particular forum post:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> forumPost = Posts.findOne(postId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> canDelete = Roles.userIsInRole(userId,</span><br><span class="line">  [<span class="string">'admin'</span>, <span class="string">'moderator'</span>], forumPost.categoryId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! canDelete) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'unauthorized'</span>,</span><br><span class="line">    <span class="string">'Only admins and moderators can delete posts.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Posts.remove(postId);</span><br></pre></td></tr></table></figure>
<p>Note that we can check for multiple roles at once, and if someone has a role in the <code>GLOBAL_GROUP</code>, they are considered as having that role in every group. In this case, the groups were by category ID, but you could use any unique identifier to make a group.</p>
<p>Read more in the <a href="https://atmospherejs.com/alanning/roles" target="_blank" rel="external"><code>alanning:roles</code> package documentation</a>.</p>
<h3 id="per-document-permissions">Per-document permissions</h3>

<p>Sometimes, it doesn’t make sense to abstract permissions into “groups” - you just want documents to have owners and that’s it. In this case, you can use a simpler strategy using collection helpers.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Lists.helpers(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  editableBy(userId) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.userId) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userId === userId;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Now, we can call this simple function to determine if a particular user is allowed to edit this list:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = Lists.findOne(listId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! list.editableBy(userId)) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'unauthorized'</span>,</span><br><span class="line">    <span class="string">'Only list owners can edit private lists.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Learn more about how to use collection helpers in the <a href="collections.html#collection-helpers">Collections article</a>.</p>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="CONTRIBUTING.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Contribution Guidelines
        </a>
      
      
        <a class="link primary next"
          href="angular.html">
          <span class="subtitle-pagination">Next</span>
          Angular
          <span class="icon-arrow-right-alt"></span>
        </a>
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/ourmeteor/guide-zh/tree/master/content/accounts.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
    <div class="discourse-comments-wrapper content-wrapper">
      <div id='discourse-comments'></div>
    </div>

    <script type="text/javascript">
      DiscourseEmbed = { discourseUrl: 'http://forums.meteor.com/',
                         topicId: 19664 };

      (function() {
        var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
        d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
      })();
    </script>
  
</div>

    <script src="/script/smooth-scroll.min.js"></script>
    <script src="/script/main.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

    <script>
      // nectar ninja
      (function(){
        var handle = '@meteorjs';
        var a = document.createElement('script');
        var m = document.getElementsByTagName('script')[0];
        a.async = 1;
        a.src = 'https://nectar.ninja/api/v1/' + handle.slice(1);
        m.parentNode.insertBefore(a, m);
      })();

     
      
        // Segment Tracking
        !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
        analytics.load("zQx6cQifkTU79E3L0XAnmrOXP2A5bC6r");
        analytics.page()
        }}();
      

      // search box
      

        ['desktop', 'mobile'].forEach(function(type) {
          var search = docsearch({
            apiKey: 'b123b42bb515f300dc09dc88f7695ec1',
            indexName: 'meteor_guide',
            inputSelector: '#' + type + '-search-input',
            autocompleteOptions: {
              dropdownMenuContainer: '.wrapper-' + type + '-search-results',
              debug: true
            }
          }).autocomplete;

          var sidebar = document.querySelector('.sidebar-content');
          search.on('autocomplete:opened', function() {
            sidebar.classList.add('searching');
          });
          search.on('autocomplete:closed', function() {
            sidebar.classList.remove('searching');
          });
          search.on('autocomplete:updated', function() {
            if (search.val() === '') {
              search.autocomplete.close();
            }
          });
        });
      

      
        var REDIRECTS = {
  "/using-packages.html": "atmosphere-vs-npm.html",
  "/using-packages.html#npm": "using-npm-packages.html",
  "/using-packages.html#client-npm": "using-npm-packages.html#client-npm",
  "/using-packages.html#installing-npm": "using-npm-packages.html#installing-npm",
  "/using-packages.html#using-npm": "using-npm-packages.html#using-npm",
  "/using-packages.html#npm-styles": "using-npm-packages.html#npm-styles",
  "/using-packages.html#npm-shrinkwrap": "using-npm-packages.html#npm-shrinkwrap",
  "/using-packages.html#atmosphere": "using-atmosphere-packages.html",
  "/using-packages.html#atmosphere-searching": "using-atmosphere-packages.html#atmosphere-searching",
  "/using-packages.html#atmosphere-naming": "using-atmosphere-packages.html#atmosphere-naming",
  "/using-packages.html#installing-atmosphere": "using-atmosphere-packages.html#installing-atmosphere",
  "/using-packages.html#using-atmosphere": "using-atmosphere-packages.html#using-atmosphere",
  "/using-packages.html#importing-atmosphere-styles": "using-atmosphere-packages.html#importing-atmosphere-styles",
  "/using-packages.html#peer-npm-dependencies": "using-atmosphere-packages.html#peer-npm-dependencies",
  "/using-packages.html#package-namespacing": "using-atmosphere-packages.html#package-namespacing",
  "/using-packages.html#async-callbacks": "using-npm-packages.html#async-callbacks",
  "/using-packages.html#bind-environment": "using-npm-packages.html#bind-environment",
  "/using-packages.html#wrap-async": "using-npm-packages.html#wrap-async",
  "/using-packages.html#promises": "using-npm-packages.html#promises",
  "/using-packages.html#overriding-packages": "writing-npm-packages.html#overriding-npm-packages",
  "/using-packages.html#npm-overriding": "writing-npm-packages.html#overriding-npm-packages",
  "/using-packages.html#atmosphere-overriding": "writing-atmosphere-packages.html#overriding-atmosphere-packages",
  "/using-packages.html#npm-shrinkpack": "using-npm-packages.html#npm-shrinkpack",
  "/writing-packages.html": "writing-atmosphere-packages.html",
  "/writing-packages.html#npm-vs-atmosphere": "atmosphere-vs-npm.html",
  "/writing-packages.html#creating-npm": "writing-npm-packages.html",
  "/writing-packages.html#including-in-app": "writing-npm-packages.html#including-in-app",
  "/writing-packages.html#publishing-npm": "writing--packages.html#publishing-npm",
  "/writing-packages.html#creating": "writing-atmosphere-packages.html",
  "/writing-packages.html#adding-files": "writing-atmosphere-packages.html#adding-files",
  "/writing-packages.html#adding-javascript": "writing-atmosphere-packages.html#adding-javascript",
  "/writing-packages.html#adding-css": "writing-atmosphere-packages.html#adding-css",
  "/writing-packages.html#adding-style": "writing-atmosphere-packages.html#adding-style",
  "/writing-packages.html#adding-assests": "writing-atmosphere-packages.html#adding-assets",
  "/writing-packages.html#exporting": "writing-atmosphere-packages.html#exporting",
  "/writing-packages.html#dependencies": "writing-atmosphere-packages.html#dependencies",
  "/writing-packages.html#atmosphere-dependencies": "writing-atmosphere--packages.html#atmosphere-dependencies",
  "/writing-packages.html#meteor-version-dependencies": "writing-atmosphere-packages.html#meteor-version-dependencies",
  "/writing-packages.html#version-constraints": "writing-atmosphere-packages.html#version-constraints",
  "/writing-packages.html#npm-dependencies": "writing-atmosphere-packages.html#npm-dependencies",
  "/writing-packages.html#peer-npm-dependencies": "writing-atmosphere-packages.html#peer-npm-dependencies",
  "/writing-packages.html#cordova-plugins": "writing-atmosphere-packages.html#cordova-plugins",
  "/writing-packages.html#testing": "writing-atmosphere-packages.html#testing",
  "/writing-packages.html#testing-with-peer-dependencies": "writing-atmosphere-packages.html#testing-with-peer-dependencies",
  "/writing-packages.html#local-vs-published": "writing-atmosphere-packages.html#local-vs-published",
  "/writing-packages.html#build-plugins": "build-tool.html#build-plugins",
  "/writing-packages.html#types-of-build-plugins": "build-tool.html#types-of-build-plugins",
  "/writing-packages.html#writing-build-plugins": "build-tool.html#writing-build-plugins",
  "/writing-packages.html#caching-build-plugins": "build-tool.html#caching-build-plugins",
  "/testing.html#simple-unit-test": "testing.html#simple-blaze-unit-test"
};

        function redirect() {
          // Support redirects of the form /path#hash
          var locationKey = location.pathname + location.hash;
          if (REDIRECTS[locationKey]) {
            location.replace(location.origin + '/' + REDIRECTS[locationKey]);
          }

          // Support redirects of the form #hash (works for any path)
          var hashKey = location.hash;
          if (REDIRECTS[hashKey]) {
            location.replace(location.origin + '/' + REDIRECTS[hashKey]);
          }
        }

        // Redirect now
        redirect();

        // Redirect on hash change
        window.onhashchange = redirect;
      
    </script>
  </body>
</html>
