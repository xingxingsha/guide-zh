<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <!-- Basic -->
    <title>Methods | Meteor 指南 中译本</title>
    <meta name="description" content="How to use Methods, Meteor's remote procedure call system, to write to the database.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="../images/favicon.png" sizes="16x16 32x32 64x64">

    <!-- Social -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://guide-zh.ourmeteor.com">
    <meta property="og:title" content="Methods | Meteor 指南 中译本">
    <meta property="og:description" content="How to use Methods, Meteor's remote procedure call system, to write to the database.">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_image_large">
    <meta name="twitter:site" content="@meteor">
    <meta name="twitter:title" content="Methods | Meteor 指南 中译本">
    <meta name="twitter:description" content="How to use Methods, Meteor's remote procedure call system, to write to the database.">
    <meta name="twitter:image" content="">

    <!-- Misc -->
    <meta name="google-site-verification" content="" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,200,300italic,400italic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/style/style.css">
  </head>
  <body class="">
    

<div class="sidebar">
  <div class="panel">
    <div class="panel-item logo">
      <a href="http://www.meteor.com/developers" title="Meteor Developers" target=_new >
        <img src="../images/icon-white.svg" alt="Meteor Developers">
        <span>Meteor Developers</span>
      </a>
    </div>
    
      <div class="panel-item "">
        <a class="" href="http://www.meteor.com/tutorials" target=_new >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><g fill="#112B49"><circle cx="80.001" cy="80" r="3"/><path d="M75.73 85.723c.193-.183.316-.437.316-.723 0-.553-.447-1-1-1-.278 0-.528.114-.71.297l-.004-.004-50.9 50.875c-.18.18-.29.43-.29.707-.002.553.445 1 .998 1 .276 0 .526-.112.708-.293l50.883-50.86zM84.235 74.4c-.18.183-.292.433-.292.71 0 .552.446 1 1 1 .275 0 .525-.113.707-.294l50.87-50.89c.204-.184.34-.442.34-.74 0-.552-.448-1-1-1-.276 0-.526.113-.707.294l-.01-.01L84.236 74.4zM136.583 135.184L85.65 84.23c-.182-.18-.432-.293-.708-.293-.552 0-1 .447-1 1 0 .278.114.528.297.71l50.927 50.95c.18.18.43.293.708.293.553 0 1-.447 1-1 0-.276-.11-.525-.292-.706zM111.19 152.602l-.003-.005-.002-.004-27.552-66.507h-.002c-.15-.362-.505-.617-.922-.617-.552 0-1 .446-1 1 0 .135.028.263.077.38v.002l.005.012 27.552 66.504c.15.362.507.617.924.617.553 0 1-.447 1-1 0-.136-.03-.265-.077-.383zM48.873 7.384L76.435 73.93h.002c.15.362.505.617.922.617.552 0 1-.447 1-1 0-.136-.03-.264-.078-.382h.003L50.72 6.616c-.15-.362-.506-.617-.923-.617-.552 0-1 .447-1 1 0 .136.03.265.078.383h-.002zM152.55 48.844h-.002L86.092 76.422c-.36.15-.617.507-.617.924 0 .553.446 1 1 1 .135 0 .265-.028.383-.077L153.32 50.69c.363-.15.618-.507.618-.924 0-.553-.447-1-1-1-.136 0-.265.028-.383.077h-.005zM7.41 111.136h.002l66.492-27.54c.36-.15.616-.507.616-.924 0-.553-.447-1-1-1-.136 0-.264.028-.382.077v-.002l-.004.002c-.002 0-.004 0-.006.002L6.638 109.29c-.36.15-.615.507-.615.924 0 .553.446 1 1 1 .135 0 .264-.028.382-.077h.004zM159 79H87c-.552 0-1 .448-1 1 0 .554.447 1 1 1h72c.553 0 1-.447 1-1s-.447-1-1-1zM23.435 24.85l50.897 50.897.008-.008c.182.18.43.29.707.29.553 0 1-.446 1-1 0-.296-.135-.555-.34-.737L24.85 23.433c-.183-.18-.433-.292-.71-.292-.55 0-.998.448-.998 1 0 .277.11.528.293.71zM6.618 50.657v.002l66.51 27.54c.003 0 .005 0 .007.002l.004.002c.117.048.245.076.38.076.554 0 1-.447 1-1 0-.417-.254-.772-.616-.923v-.002L7.392 48.813H7.39l-.005-.003c-.118-.047-.247-.076-.383-.076-.552 0-1 .447-1 1 0 .417.256.773.618.923zM153.383 109.28l-66.52-27.53-.006-.002c-.118-.048-.248-.076-.384-.076-.552 0-1 .447-1 1 0 .417.256.773.62.923l66.513 27.528c.003 0 .005 0 .007.002l.004.002c.118.048.246.076.382.076.552 0 1-.447 1-1 0-.417-.256-.772-.617-.923zM80 74c.553 0 1-.447 1-1V1c0-.553-.447-1-1-1-.552 0-1 .447-1 1v72c0 .553.447 1 1 1zM80 86c-.552 0-1 .447-1 1v72c0 .553.447 1 1 1s1-.447 1-1V87c0-.553-.447-1-1-1zM77.36 85.47c-.417 0-.772.254-.923.616l-27.564 66.53.002.002c-.05.117-.077.246-.077.382 0 .553.446 1 1 1 .416 0 .772-.255.922-.618h.002L78.28 86.86v-.004l.003-.005c.048-.117.076-.246.076-.382 0-.552-.448-1-1-1zM82.708 74.547c.417 0 .772-.255.923-.618h.003l27.56-66.547h-.004c.048-.12.076-.247.076-.383 0-.553-.447-1-1-1-.416 0-.772.255-.922.618h-.002l-27.56 66.546h.004c-.05.12-.077.247-.077.383-.002.553.445 1 .998 1zM74 80c0-.552-.446-1-1-1H1c-.552 0-1 .447-1 1 0 .553.447 1 1 1h72c.554 0 1-.446 1-1z"/></g></svg>
          <span>教程</span>
        </a>
      </div>
    
      <div class="panel-item active"">
        <a class="" href="http://guide.meteor.com"  >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#BDA671" d="M80 1.988c43.01 0 78 34.99 78 78s-34.99 78-78 78-78-34.99-78-78 34.99-78 78-78m0-2c-44.183 0-80 35.817-80 80s35.817 80 80 80 80-35.817 80-80-35.817-80-80-80z"/><path fill="#BDA671" d="M126.454 33.545l-37.93 54.98-54.98 37.93 37.93-54.98 54.98-37.93m0-2c-.395 0-.79.116-1.135.354L70.336 69.826c-.2.138-.373.312-.51.51l-37.93 54.98c-.548.796-.45 1.868.232 2.55.386.388.898.587 1.414.587.395 0 .79-.116 1.135-.354l54.98-37.93c.2-.137.373-.31.51-.51l37.93-54.98c.548-.795.45-1.867-.232-2.55-.387-.386-.9-.585-1.414-.585z"/><circle fill="#BDA671" cx="79.999" cy="79.999" r="2.999"/><path fill="#BDA671" d="M135.477 50.182c-.02-.036-.04-.05-.06-.045-.173-.303-.485-.516-.858-.516-.553 0-1 .448-1 1 0 .21.078.394.188.554l-.02.007C138.358 59.766 141 69.57 141 79.99c0 33.636-27.364 61-61 61-10.42 0-20.232-2.634-28.82-7.26l-.005.02c-.144-.08-.3-.14-.478-.14-.552 0-1 .448-1 1 0 .336.176.618.43.8-.016.012-.034.025-.03.027 8.896 4.81 19.078 7.552 29.904 7.552 34.795 0 63-28.206 63-63 0-10.79-2.735-20.93-7.523-29.805zM109.65 24.47c-.002-.02.004-.04-.025-.056-8.83-4.727-18.908-7.426-29.625-7.426-34.794 0-63 28.206-63 63 0 10.79 2.73 20.935 7.514 29.81.005.01.012.004.018.01.17.312.488.532.87.532.552 0 1-.447 1-1 0-.197-.073-.37-.17-.525l.04-.002C21.642 100.223 19 90.41 19 79.988c0-33.636 27.364-61 61-61 10.4 0 20.185 2.634 28.757 7.248.02.01.036.02.055.028.116.047.24.075.37.075.554 0 1-.448 1-1 .002-.382-.22-.7-.533-.87z"/></svg>
          <span>指南</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="http://docs.meteor.com"  >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#DE4F4F" d="M35.6 30.167v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375h89.8c.553 0 1 .447 1 1v7.375c0 .55-.447 1-1 1H35.6v5.375H80c.552 0 1 .447 1 1v10.873c1.162.413 2 1.51 2 2.816 0 1.657-1.343 3-3 3s-3-1.343-3-3c0-1.305.837-2.402 2-2.815v-9.873H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.45-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1v-7.375c0-.553.448-1 1-1h89.8v-5.375H34.6c-.552 0-1-.447-1-1s.448-1 1-1h90.8c.553 0 1 .447 1 1v7.375c0 .553-.447 1-1 1H35.6zM138 6.564H22c-1.104 0-2 .896-2 2v144c0 1.104.896 2 2 2h48.995c.258 0 .516-.097.712-.293.39-.39.39-1.022 0-1.413-.195-.195-.45-.293-.707-.293H22v-144h116v144H89.006c-.258 0-.517.097-.713.293-.39.39-.39 1.023 0 1.414.196.198.455.294.713.293H138c1.104 0 2-.895 2-2v-144c0-1.103-.896-2-2-2z"/></svg>
          <span>API 文档</span>
        </a>
      </div>
    
      <div class="panel-item "">
        <a class="" href="https://forums.meteor.com/" target=_new >
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><path fill="#333" d="M60.025 17.72c7.396 0 14.914 1.424 22.172 4.43 29.594 12.258 43.648 46.188 31.39 75.782-9.25 22.334-30.843 35.812-53.6 35.812-4.694 0-9.437-.574-14.132-1.76L32.44 142.277 30.23 125.51C5.908 111.003-4.74 80.48 6.418 53.538 15.67 31.204 37.266 17.72 60.025 17.72m0-2c-24.363 0-46.13 14.545-55.455 37.053-5.547 13.394-6.06 28.33-1.447 42.052 4.465 13.276 13.414 24.57 25.252 31.896l2.082 15.82c.092.708.557 1.31 1.217 1.585.246.104.506.152.766.152.434 0 .86-.142 1.217-.412l12.656-9.713c4.482 1.055 9.076 1.59 13.674 1.59 24.36 0 46.126-14.543 55.447-37.047 6.135-14.807 6.135-31.115.002-45.922C109.3 37.966 97.77 26.433 82.963 20.3c-7.34-3.04-15.06-4.58-22.938-4.58zM92.69 133.9c.165-.443.614-.683 1.064-.623l.004-.024c5.18.558 10.343.396 15.365-.414v2.034c-5.13.796-10.4.942-15.69.356l.002-.02c-.052-.01-.105-.006-.158-.023-.517-.193-.78-.768-.586-1.287z"/><path fill="#333" d="M100.877 133.604c4.41-.065 8.86-.633 13.268-1.746l13.416 10.295 2.208-16.77c24.324-14.505 34.976-45.03 23.814-71.97-9.248-22.33-30.832-35.81-53.584-35.82v.02c-2.072-.002-4.154.096-6.238.32l-.004-.024c-.45.058-.9-.18-1.064-.625-.194-.518.068-1.093.586-1.286.054-.02.107-.015.158-.026l-.002-.02c2.19-.24 4.377-.348 6.553-.35v-.01c24.36.004 46.12 14.545 55.443 37.054 5.55 13.393 6.062 28.327 1.447 42.05-4.465 13.28-13.414 24.57-25.252 31.897l-2.082 15.818c-.092.71-.557 1.312-1.217 1.586-.246.103-.506.15-.766.15-.435 0-.86-.14-1.218-.412l-12.655-9.713c-4.2.988-8.502 1.502-12.812 1.564l.002-1.986z"/><circle fill="#333" cx="60.019" cy="77" r="3.001"/><circle fill="#333" cx="76.018" cy="77" r="3"/><circle fill="#333" cx="44.019" cy="77" r="3.001"/></svg>

          <span>论坛</span>
        </a>
      </div>
    
  </div>

  <div class="sidebar-content">
    <div class="topcap">
      <span class="title-sidebar">Meteor 指南 中译本</span>
      
        <span class="select version-sidebar nochrome">
          <select class="version-select">
            
              <option value="v1.3">1.3</option>
            
              <option value="v1.2">1.2</option>
            
          </select>
        </span>
      
    </div>

    
    <div class="wrapper-search">
      <div class="input-symbol small round">
        <input type="text" placeholder="Search 官方指南" id="desktop-search-input" />
        <span class="icon-search"></span>
      </div>
      <div class="wrapper-desktop-search-results"></div>
    </div>

    

    <ul class="toc">
      
        <li>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="index.html" class="sidebar-link ">
                  <span>介绍</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="code-style.html" class="sidebar-link ">
                  <span>编码风格</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="structure.html" class="sidebar-link ">
                  <span>Application Structure</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="1.3-migration.html" class="sidebar-link ">
                  <span>Migrating to Meteor 1.3</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">数据</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="collections.html" class="sidebar-link ">
                  <span>数据集与数据结构</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="data-loading.html" class="sidebar-link ">
                  <span>Publications and Data Loading</span>
                </a>
              </li>
            
              
              <li class="item-toc  current">
                <a href="" class="sidebar-link  current">
                  <span>Methods</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="accounts.html" class="sidebar-link ">
                  <span>Users and Accounts</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="testing.html" class="sidebar-link ">
                  <span>Testing</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">视图</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="routing.html" class="sidebar-link ">
                  <span>URL 和路由</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="ui-ux.html" class="sidebar-link ">
                  <span>User Interfaces</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="blaze.html" class="sidebar-link ">
                  <span>Blaze</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="react.html" class="sidebar-link ">
                  <span>React</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="angular.html" class="sidebar-link ">
                  <span>Angular</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">构建</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="atmosphere-vs-npm.html" class="sidebar-link ">
                  <span>Atmosphere vs. npm</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="using-atmosphere-packages.html" class="sidebar-link ">
                  <span>Using Atmosphere Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="writing-atmosphere-packages.html" class="sidebar-link ">
                  <span>Writing Atmosphere Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="using-npm-packages.html" class="sidebar-link ">
                  <span>Using npm Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="writing-npm-packages.html" class="sidebar-link ">
                  <span>Writing npm Packages</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="mobile.html" class="sidebar-link ">
                  <span>Mobile</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="build-tool.html" class="sidebar-link ">
                  <span>Build System</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">生产环境</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="security.html" class="sidebar-link ">
                  <span>Security</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="deployment.html" class="sidebar-link ">
                  <span>Deployment and Monitoring</span>
                </a>
              </li>
            
          </ul>
        </li>
      
        <li>
          
            <div class="heading-toc">有关本指南</div>
          
          <ul class="list-toc">
            
              
              <li class="item-toc ">
                <a href="CONTRIBUTING.html" class="sidebar-link ">
                  <span>Contribution Guidelines</span>
                </a>
              </li>
            
              
              <li class="item-toc ">
                <a href="CHANGELOG.html" class="sidebar-link ">
                  <span>Changelog</span>
                </a>
              </li>
            
          </ul>
        </li>
      
    </ul>
  </div>
</div>


<div class="nav dark">
  <div class="nav-group">
    <div class="nav-item">
      <span class="js-sidebar-toggle">
        <span class="icon-menu"></span>
      </span>
    </div>
  </div>

  <div class="center-wrapper">
    <img src="../images/logo-coralspace.svg" alt="Meteor 指南 中译本"/>
    <div>官方指南</div>
  </div>

  
  <div class="nav-group right">
    <div class="nav-item">
      <span class="js-search-toggle">
        <span class="icon-search"></span>
      </span>
    </div>
  </div>

  <div class="nav-search">
    <div class="input-symbol">
      <input type="text" placeholder="Search 官方指南" id="mobile-search-input"/>
      <span class="icon-search"></span>
    </div>

    <div class="nav-group right">
      <div class="nav-item">
        <span class="js-search-toggle">
          <span class="icon-close"></span>
        </span>
      </div>
    </div>
    
    <div class="wrapper-mobile-search-results"></div>
  </div>
  
</div>

<div class="content">
  <div class="content-wrapper">
    <div class="header-content">
      <h1 class="title-page">Methods</h1>
      
        <div class="subtitle-page">How to use Methods, Meteor's remote procedure call system, to write to the database.</div>
      

      <div class="page-actions">
        <div class="actions-group">
          <a class="btn primary small round lowercase" href="https://github.com/ourmeteor/guide-zh/tree/master/content/methods.md" target="_blank"><span class="icon-github"></span> <span>Edit on GitHub</span></a>
          
            <a class="btn tertiary small round lowercase" href="https://forums.meteor.com/t/19662"><span class="icon-comment"></span> <span>Discuss</span></a>
          
        </div>
      </div>
    </div>

    <div class="document-formatting">
      <p>After reading this article, you’ll know:</p>
<ol>
<li>What Methods are in Meteor and how they work in detail.</li>
<li>Best practices for defining and calling Methods.</li>
<li>How to throw and handle errors with Methods.</li>
<li>How to call a Method from a form.</li>
</ol>
<h2 id="what-is-a-method">What is a Method?</h2>

<p>Methods are Meteor’s remote procedure call (RPC) system, used to save user input events and data that come from the client. If you’re familiar with REST APIs or HTTP, you can think of them like POST requests to your server, but with many nice features optimized for building a modern web application. Later on in this article, we’ll go into detail about some of the benefits you get from Methods that you wouldn’t get from an HTTP endpoint.</p>
<p>At its core, a Method is an API endpoint for your server; you can define a Method on the server and its counterpart on the client, then call it with some data, write to the database, and get the return value in a callback. Meteor Methods are also tightly integrated with the pub/sub and data loading systems of Meteor to allow for <a href="http://info.meteor.com/blog/optimistic-ui-with-meteor-latency-compensation" target="_blank" rel="external">Optimistic UI</a> - the ability to simulate server-side actions on the client to make your app feel faster than it actually is.</p>
<p>We’ll be referring to Meteor Methods with a capital M to differentiate them from class methods in JavaScript.</p>
<h2 id="defining-and-calling">Defining and calling Methods</h2>

<h3 id="basic">Basic Method</h3>

<p>In a basic app, defining a Meteor Method is as simple as defining a function. In a complex app, you want a few extra features to make Methods more powerful and easily testable. First, we’re going to go over how to define a Method using the Meteor core API, and in a later section we’ll go over how to use a helpful wrapper package we’ve created to enable a more powerful Method workflow.</p>
<h4 id="basic-defining">Defining</h4>

<p>Here’s how you can use the built-in <a href="http://docs.meteor.com/#/full/meteor_methods" target="_blank" rel="external"><code>Meteor.methods</code> API</a> to define a Method. Note that Methods should always be defined in common code loaded on the client and the server to enable Optimistic UI. If you have some secret code in your Method, consult the <a href="security.html#secret-code">Security article</a> for how to hide it from the client.</p>
<p>This example uses the <code>aldeed:simple-schema</code> package, which is recommended in several other articles, to validate the Method arguments.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Meteor.methods(&#123;</span><br><span class="line">  <span class="string">'todos.updateText'</span>(&#123; todoId, newText &#125;) &#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">      todoId: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">      newText: &#123; type: <span class="built_in">String</span> &#125;</span><br><span class="line">    &#125;).validate(&#123; todoId, newText &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> todo = Todos.findOne(todoId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!todo.editableBy(<span class="keyword">this</span>.userId)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'todos.updateText.unauthorized'</span>,</span><br><span class="line">        <span class="string">'Cannot edit todos in a private list that is not yours'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Todos.update(todoId, &#123;</span><br><span class="line">      $set: &#123; text: newText &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="basic-calling">Calling</h4>

<p>This Method is callable from the client and server using <a href="http://docs.meteor.com/#/full/meteor_call" target="_blank" rel="external"><code>Meteor.call</code></a>. Note that you should only use a Method in the case where some code needs to be callable from the client; if you just want to modularize code that is only going to be called from the server, use a regular JavaScript function, not a Method.</p>
<p>Here’s how you can call this Method from the client:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Meteor.call(<span class="string">'todos.updateText'</span>, &#123;</span><br><span class="line">  todoId: <span class="string">'12345'</span>,</span><br><span class="line">  newText: <span class="string">'This is a todo item.'</span></span><br><span class="line">&#125;, (err, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    alert(err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// success!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If the Method throws an error, you get that in the first argument of the callback. If the Method succeeds, you get the result in the second argument and the first argument <code>err</code> will be <code>undefined</code>. For more information about errors, see the section below about error handling.</p>
<h3 id="advanced-boilerplate">Advanced Method boilerplate</h3>

<p>Meteor Methods have several features which aren’t immediately obvious, but every complex app will need them at some point. These features were added incrementally over several years in a backwards-compatible fashion, so unlocking the full capabilities of Methods requires a good amount of boilerplate. In this article we will first show you all of the code you need to write for each feature, then the next section will talk about a Method wrapper package we have developed to make it easier.</p>
<p>Here’s some of the functionality an ideal Method would have:</p>
<ol>
<li>Run validation code by itself without running the Method body.</li>
<li>Easily override the Method for testing.</li>
<li>Easily call the Method with a custom user ID, especially in tests (as recommended by the <a href="https://www.discovermeteor.com/blog/meteor-pattern-two-tiered-methods/" target="_blank" rel="external">Discover Meteor two-tiered methods pattern</a>).</li>
<li>Refer to the Method via JS module rather than a magic string.</li>
<li>Get the Method simulation return value to get IDs of inserted documents.</li>
<li>Avoid calling the server-side Method if the client-side validation failed, so we don’t waste server resources.</li>
</ol>
<h4 id="advanced-boilerplate-defining">Defining</h4>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> updateText = &#123;</span><br><span class="line">  name: <span class="string">'todos.updateText'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Factor out validation so that it can be run independently (1)</span></span><br><span class="line">  validate(args) &#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">      todoId: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">      newText: &#123; type: <span class="built_in">String</span> &#125;</span><br><span class="line">    &#125;).validate(args)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Factor out Method body so that it can be called independently (3)</span></span><br><span class="line">  run(&#123; todoId, newText &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> todo = Todos.findOne(todoId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!todo.editableBy(<span class="keyword">this</span>.userId)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'todos.updateText.unauthorized'</span>,</span><br><span class="line">        <span class="string">'Cannot edit todos in a private list that is not yours'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Todos.update(todoId, &#123;</span><br><span class="line">      $set: &#123; text: newText &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call Method by referencing the JS object (4)</span></span><br><span class="line">  <span class="comment">// Also, this lets us specify Meteor.apply options once in</span></span><br><span class="line">  <span class="comment">// the Method implementation, rather than requiring the caller</span></span><br><span class="line">  <span class="comment">// to specify it at the call site.</span></span><br><span class="line">  call(args, callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      returnStubValue: <span class="literal">true</span>,     <span class="comment">// (5)</span></span><br><span class="line">      throwStubExceptions: <span class="literal">true</span>  <span class="comment">// (6)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Meteor.apply(<span class="keyword">this</span>.name, [args], options, callback);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually register the method with Meteor's DDP system</span></span><br><span class="line">Meteor.methods(&#123;</span><br><span class="line">  [updateText.name]: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">    updateText.validate.call(<span class="keyword">this</span>, args);</span><br><span class="line">    updateText.run.call(<span class="keyword">this</span>, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="advanced-boilerplate-calling">Calling</h4>

<p>Now calling the Method is as simple as calling a JavaScript function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; updateText &#125; <span class="keyword">from</span> <span class="string">'./path/to/methods.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call the Method</span></span><br><span class="line">updateText.call(&#123;</span><br><span class="line">  todoId: <span class="string">'12345'</span>,</span><br><span class="line">  newText: <span class="string">'This is a todo item.'</span></span><br><span class="line">&#125;, (err, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    alert(err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// success!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call the validation only</span></span><br><span class="line">updateText.validate(&#123; wrong: <span class="string">'args'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call the Method with custom userId in a test</span></span><br><span class="line">updateText.run.call(&#123; userId: <span class="string">'abcd'</span> &#125;, &#123;</span><br><span class="line">  todoId: <span class="string">'12345'</span>,</span><br><span class="line">  newText: <span class="string">'This is a todo item.'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As you can see, this approach to calling Methods results in a better development workflow - you can more easily deal with the different parts of the Method separately and test your code more easily without having to deal with Meteor internals. But this approach requires you to write a lot of boilerplate on the Method definition side.</p>
<h3 id="validated-method">Advanced Methods with mdg:validated-method</h3>

<p>To alleviate some of the boilerplate that’s involved in correct Method definitions, we’ve published a wrapper package called <code>mdg:validated-method</code> that does most of this for you. Here’s the same Method as above, but defined with the package:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> updateText = <span class="keyword">new</span> ValidatedMethod(&#123;</span><br><span class="line">  name: <span class="string">'todos.updateText'</span>,</span><br><span class="line">  validate: <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">    todoId: &#123; type: <span class="built_in">String</span> &#125;,</span><br><span class="line">    newText: &#123; type: <span class="built_in">String</span> &#125;</span><br><span class="line">  &#125;).validator(),</span><br><span class="line">  run(&#123; todoId, newText &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> todo = Todos.findOne(todoId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!todo.editableBy(<span class="keyword">this</span>.userId)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'todos.updateText.unauthorized'</span>,</span><br><span class="line">        <span class="string">'Cannot edit todos in a private list that is not yours'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Todos.update(todoId, &#123;</span><br><span class="line">      $set: &#123; text: newText &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>You call it the same way you call the advanced Method above, but the Method definition is significantly simpler. We believe this style of Method lets you clearly see the important parts - the name of the Method sent over the wire, the format of the expected arguments, and the JavaScript namespace by which the Method can be referenced.</p>
<h2 id="errors">Error handling</h2>

<p>In regular JavaScript functions, you indicate errors by throwing an <code>Error</code> object. Throwing errors from Meteor Methods works almost the same way, but a bit of complexity is introduced by the fact that in some cases the error object will be sent over a websocket back to the client.</p>
<h3 id="throwing-errors">Throwing errors from a Method</h3>

<p>Meteor introduces two new types of JavaScript errors: <a href="http://docs.meteor.com/#/full/meteor_error" target="_blank" rel="external"><code>Meteor.Error</code></a> and <a href="https://atmospherejs.com/mdg/validation-error" target="_blank" rel="external"><code>ValidationError</code></a>. These and the regular JavaScript <code>Error</code> type should be used in different situations:</p>
<h4 id="internal-server-errors">Regular <code>Error</code> for internal server errors</h4>

<p>When you have an error that doesn’t need to be reported to the client, but is internal to the server, throw a regular JavaScript error object. This will be reported to the client as a totally opaque internal server error with no details.</p>
<h4 id="meteor-error">Meteor.Error for general runtime errors</h4>

<p>When the server was not able to complete the user’s desired action because of a known condition, you should throw a descriptive <code>Meteor.Error</code> object to the client. In the Todos example app, we use these to report situations where the current user is not authorized to complete a certain action, or where the action is not allowed within the app - for example, deleting the last public list.</p>
<p><code>Meteor.Error</code> takes three arguments: <code>error</code>, <code>reason</code>, and <code>details</code>.</p>
<ol>
<li><code>error</code> should be a short, unique, machine-readable error code string that the client can interpret to understand what happened. It’s good to prefix this with the name of the Method for easy internationalization, for example: <code>&#39;todos.updateText.unauthorized&#39;</code>.</li>
<li><code>reason</code> should be a short description of the error for the developer. It should give your coworker enough information to be able to debug the error. The <code>reason</code> parameter should not be printed to the end user directly, since this means you now have to do internationalization on the server before sending the error message, and the UI developer has to worry about the Method implementation when thinking about what will be displayed in the UI.</li>
<li><code>details</code> is optional, and can be used where extra data will help the client understand what is wrong. In particular, it can be combined with the <code>error</code> field to print a more helpful error message to the end user.</li>
</ol>
<h4 id="validation-error">ValidationError for argument validation errors</h4>

<p>When a Method call fails because the arguments are of the wrong type, it’s good to throw a <code>ValidationError</code>. This works just like <code>Meteor.Error</code>, but is a custom constructor that enforces a standard error format that can be read by different form and validation libraries. In particular, if you are calling this Method from a form, throwing a <code>ValidationError</code> will make it easy to display nice error messages next to particular fields in the form.</p>
<p>When you use <code>mdg:validated-method</code> with <code>aldeed:simple-schema</code> as demonstrated above, this type of error is thrown for you.</p>
<p>Read more about the error format in the <a href="https://atmospherejs.com/mdg/validation-error" target="_blank" rel="external"><code>mdg:validation-error</code> docs</a>.</p>
<h3 id="handling-errors">Handling errors</h3>

<p>When you call a Method, any errors thrown by it will be returned in the callback. At this point, you should identify which error type it is and display the appropriate message to the user. In this case, it is unlikely that the Method will throw a <code>ValidationError</code> or an internal server error, so we will only handle the unauthorized error:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call the Method</span></span><br><span class="line">updateText.call(&#123;</span><br><span class="line">  todoId: <span class="string">'12345'</span>,</span><br><span class="line">  newText: <span class="string">'This is a todo item.'</span></span><br><span class="line">&#125;, (err, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.error === <span class="string">'todos.updateText.unauthorized'</span>) &#123;</span><br><span class="line">      <span class="comment">// Displaying an alert is probably not what you would do in</span></span><br><span class="line">      <span class="comment">// a real app; you should have some nice UI to display this</span></span><br><span class="line">      <span class="comment">// error, and probably use an i18n library to generate the</span></span><br><span class="line">      <span class="comment">// message from the error code.</span></span><br><span class="line">      alert(<span class="string">'You aren\'t allowed to edit this todo item'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Unexpected error, handle it in the UI somehow</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// success!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>We’ll talk about how to handle the <code>ValidationError</code> in the section on forms below.</p>
<h3 id="throw-stub-exceptions">Errors in Method simulation</h3>

<p>When a Method is called, it usually runs twice—once on the client to simulate the result for Optimistic UI, and again on the server to make the actual change to the database. This means that if your Method throws an error, it will likely fail on the client <em>and</em> the server. For this reason, <code>ValidatedMethod</code> turns on undocumented option in Meteor to avoid calling the server-side implementation if the simulation throws an error.</p>
<p>While this behavior is good for saving server resources in cases where a Method will certainly fail, it’s important to make sure that the simulation doesn’t throw an error in cases where the server Method would have succeeded (for example, if you didn’t load some data on the client that the Method needs to do the simulation properly). In this case, you can wrap server-side-only logic in a block that checks for a method simulation:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.isSimulation) &#123;</span><br><span class="line">  <span class="comment">// Logic that depends on server environment here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="method-form">Calling a Method from a form</h2>

<p>The main thing enabled by the <code>ValidationError</code> convention is simple integration between Methods and the forms that call them. In general, your app is likely to have a one-to-one mapping of forms in the UI to Methods. First, let’s define a Method for our business logic:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This Method encodes the form validation requirements.</span></span><br><span class="line"><span class="comment">// By defining them in the Method, we do client and server-side</span></span><br><span class="line"><span class="comment">// validation in one place.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> insert = <span class="keyword">new</span> ValidatedMethod(&#123;</span><br><span class="line">  name: <span class="string">'Invoices.methods.insert'</span>,</span><br><span class="line">  validate: <span class="keyword">new</span> SimpleSchema(&#123;</span><br><span class="line">    email: &#123; type: <span class="built_in">String</span>, regEx: SimpleSchema.RegEx.Email &#125;,</span><br><span class="line">    description: &#123; type: <span class="built_in">String</span>, min: <span class="number">5</span> &#125;,</span><br><span class="line">    amount: &#123; type: <span class="built_in">String</span>, regEx: <span class="regexp">/^\d*\.(\d\d)?$/</span> &#125;</span><br><span class="line">  &#125;).validator(),</span><br><span class="line">  run(newInvoice) &#123;</span><br><span class="line">    <span class="comment">// In here, we can be sure that the newInvoice argument is</span></span><br><span class="line">    <span class="comment">// validated.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.userId) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Meteor.Error(<span class="string">'Invoices.methods.insert.not-logged-in'</span>,</span><br><span class="line">        <span class="string">'Must be logged in to create an invoice.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Invoices.insert(newInvoice)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Let’s define a simple HTML form:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">"Invoices_newInvoice"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"Invoices_newInvoice"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span>&gt;</span>Recipient email<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> /&gt;</span></span><br><span class="line">    &#123;&#123;#each error in errors "email"&#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-error"</span>&gt;</span>&#123;&#123;error&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;&#123;/each&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"description"</span>&gt;</span>Item description<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"description"</span> /&gt;</span></span><br><span class="line">    &#123;&#123;#each error in errors "description"&#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-error"</span>&gt;</span>&#123;&#123;error&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;&#123;/each&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"amount"</span>&gt;</span>Amount owed<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"amount"</span> /&gt;</span></span><br><span class="line">    &#123;&#123;#each error in errors "amount"&#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-error"</span>&gt;</span>&#123;&#123;error&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;&#123;/each&#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Now, let’s write some JavaScript to handle this form nicely:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; insert &#125; <span class="keyword">from</span> <span class="string">'../api/invoices/methods.js'</span>;</span><br><span class="line"></span><br><span class="line">Template.Invoices_newInvoice.onCreated(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.errors = <span class="keyword">new</span> ReactiveDict();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Template.Invoices_newInvoice.helpers(&#123;</span><br><span class="line">  errors(fieldName) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.errors.get(fieldName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Template.Invoices_newInvoice.events(&#123;</span><br><span class="line">  <span class="string">'submit .Invoices_newInvoice'</span>(event, instance) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      email: event.target.email.value,</span><br><span class="line">      description: event.target.description.value,</span><br><span class="line">      amount: event.target.amount.value</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    insert.call(data, (err, res) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err.error === <span class="string">'validation-error'</span>) &#123;</span><br><span class="line">          <span class="comment">// Initialize error object</span></span><br><span class="line">          <span class="keyword">const</span> errors = &#123;</span><br><span class="line">            email: [],</span><br><span class="line">            description: [],</span><br><span class="line">            amount: []</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Go through validation errors returned from Method</span></span><br><span class="line">          err.details.forEach((fieldError) =&gt; &#123;</span><br><span class="line">            <span class="comment">// XXX i18n</span></span><br><span class="line">            errors[fieldError.name].push(fieldError.type);</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Update ReactiveDict, errors will show up in the UI</span></span><br><span class="line">          instance.errors.set(errors);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>As you can see, there is a fair amount of boilerplate to handle errors nicely in a form, but most of it can be easily abstracted by an off-the-shelf form framework or a simple application-specific wrapper of your own design.</p>
<h2 id="loading-data">Loading data with Methods</h2>

<p>Since Methods can work as general purpose RPCs, they can also be used to fetch data instead of publications. There are some advantages and some disadvantages to this approach compared with loading data through publications, and at the end of the day we recommend always using publications to load data.</p>
<p>Methods can be useful to fetch the result of a complex computation from the server that doesn’t need to update when the server data changes. The biggest disadvantage of fetching data through Methods is that the data won’t be automatically loaded into Minimongo, Meteor’s client-side data cache, so you’ll need to manage the lifecycle of that data manually.</p>
<h4 id="local-collection">Using a local collection to store and display data fetched from a Method</h4>

<p>Collections are a very convenient way of storing data on the client side. If you’re fetching data using something other than subscriptions, you can put it in a collection manually. Let’s look at an example where we have a complex algorithm for calculating average scores from a series of games for a number of players. We don’t want to use a publication to load this data because we want to control exactly when it runs, and don’t want the data to be cached automatically.</p>
<p>First, you need to create a <em>local collection</em> - this is a collection that exists only on the client side and is not tied to a database collection on the server. Read more in the <a href="http://guide.meteor.com/collections.html#local-collections" target="_blank" rel="external">Collections article</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In client-side code, declare a local collection</span></span><br><span class="line"><span class="comment">// by passing `null` as the argument</span></span><br><span class="line">ScoreAverages = <span class="keyword">new</span> Mongo.Collection(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>Now, if you fetch data using a Method, you can put into this collection:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; calculateAverages &#125; <span class="keyword">from</span> <span class="string">'../api/games/methods.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateAverages</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Clean out result cache</span></span><br><span class="line">  ScoreAverages.remove(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call a Method that does an expensive computation</span></span><br><span class="line">  calculateAverages.call((err, res) =&gt; &#123;</span><br><span class="line">    res.forEach((item) =&gt; &#123;</span><br><span class="line">      ScoreAverages.insert(item);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can now use the data from the local collection <code>ScoreAverages</code> inside a UI component exactly the same way we would use a regular MongoDB collection. Instead of it updating automatically, we’ll need to call <code>updateAverages</code> every time we need new results.</p>
<h2 id="advanced">Advanced concepts</h2>

<p>While you can easily use Methods in a simple app by following the Meteor introductory tutorial, it’s important to understand exactly how they work to use them effectively in a production app. One of the downsides of using a framework like Meteor that does a lot for you under the hood is that you don’t always understand what is going on, so it’s good to learn some of the core concepts.</p>
<h3 id="call-lifecycle">Method call lifecycle</h3>

<p>Here’s exactly what happens, in order, when a Method is called:</p>
<h4 id="lifecycle-simulation">1. Method simulation runs on the client</h4>

<p>If we defined this Method in client and server code, as all Methods should be, a Method simulation is executed in the client that called it.</p>
<p>The client enters a special mode where it tracks all changes made to client-side collections, so that they can be rolled back later. When this step is complete, the user of your app sees their UI update instantly with the new content of the client-side database, but the server hasn’t received any data yet.</p>
<p>If an exception is thrown from the Method simulation, then by default Meteor ignores it and continues to step (2). If you are using <code>ValidatedMethod</code> or pass a special <code>throwStubExceptions</code> option to <code>Meteor.apply</code>, then an exception thrown from the simulation will stop the server-side Method from running at all.</p>
<p>The return value of the Method simulation is discarded, unless the <code>returnStubValue</code> option is passed when calling the Method, in which case it is returned to the Method caller. ValidatedMethod passes this option by default.</p>
<h4 id="lifecycle-ddp-message">2. A <code>method</code> DDP message is sent to the server</h4>

<p>The Meteor client constructs a DDP message to send to the server. This includes the Method name, arguments, and an automatically generated Method ID that represents this particular Method invocation.</p>
<h4 id="lifecycle-server">3. Method runs on the server</h4>

<p>When the server receives the message, it executes the Method code again on the server. The client side version was a simulation that will be rolled back later, but this time it’s the real version that is writing to the actual database. Running the actual Method logic on the server is crucial because the server is a trusted environment where we know that security-critical code will run the way we expect.</p>
<h4 id="lifecycle-result">4. Return value is sent to the client</h4>

<p>Once the Method has finished running on the server, it sends a <code>result</code> message to the client with the Method ID generated in step 2, and the return value itself. The client stores this for later use, but <em>doesn’t call the Method callback yet</em>. If you pass the <a href="http://docs.meteor.com/#/full/meteor_apply" target="_blank" rel="external"><code>onResultReceived</code> option to <code>Meteor.apply</code></a>, that callback is fired.</p>
<h4 id="lifecycle-publications">5. Any DDP publications affected by the Method are updated</h4>

<p>If we have any publications on the page that have been affected by the database writes from this Method, the server sends the appropriate updates to the client. Note that the client data system doesn’t reveal these updates to the app UI until the next step.</p>
<h4 id="lifecycle-updated">6. <code>updated</code> message sent to the client, data replaced with server result, Method callback fires</h4>

<p>After the relevant data updates have been sent to the correct client, the server sends back the last message in the Method life cycle - the DDP <code>updated</code> message with the relevant Method ID. The client rolls back any changes to client side data made in the Method simulation in step 1, and replaces them with the actual changes sent from the server in step 5.</p>
<p>Lastly, the callback passed to <code>Meteor.call</code> actually fires with the return value from step 4. It’s important that the callback waits until the client is up to date, so that your Method callback can assume that the client state reflects any changes done inside the Method.</p>
<h4 id="lifecycle-error">Error case</h4>

<p>In the list above, we didn’t cover the case when the Method execution on the server throws an error. In that case, there is no return value, and the client gets an error instead. The Method callback is fired instantly with the returned error as the first argument. Read more about error handling in the section about errors below.</p>
<h3 id="methods-vs-rest">Benefits of Methods over REST</h3>

<p>We believe Methods provide a much better primitive for building modern applications than REST endpoints built on HTTP. Let’s go over some of the things you get for free with Methods that you would have to worry about if using HTTP. The purpose of this section is not to convince you that REST is bad - it’s just to remind you that you don’t need to handle these things yourself in a Meteor app.</p>
<h4 id="non-blocking">Methods use synchronous-style APIs, but are non-blocking</h4>

<p>You may notice in the example Method above, we didn’t need to write any callbacks when interacting with MongoDB, but the Method still has the non-blocking properties that people associate with Node.js and callback-style code. Meteor uses a coroutine library called <a href="https://github.com/laverdet/node-fibers" target="_blank" rel="external">Fibers</a> to enable you to write code that uses return values and throws errors, and avoid dealing with lots of nested callbacks.</p>
<h4 id="ordered">Methods always run and return in order</h4>

<p>When accessing a REST API, you will sometimes run into a situation where you make two requests one after the other, but the results arrive out of order. Meteor’s underlying machinery makes sure this never happens with Methods. When multiple Method calls are received <em>from the same client</em>, Meteor runs each Method to completion before starting the next one. If you need to disable this functionality for one particularly long-running Method, you can use <a href="http://docs.meteor.com/#/full/method_unblock" target="_blank" rel="external"><code>this.unblock()</code></a> to allow the next Method to run while the current one is still in progress. Also, since Meteor is based on Websockets instead of HTTP, all Method calls and results are guaranteed to arrive in the order they are sent. You can also pass a special option <code>wait: true</code> to <code>Meteor.apply</code> to wait to send a particular Method until all others have returned, and not send any other Methods until this one returns.</p>
<h4 id="change-tracking">Change tracking for Optimistic UI</h4>

<p>When Method simulations and server-side executions run, Meteor tracks any resulting changes to the database. This is what lets the Meteor data system roll back the changes from the Method simulation and replace them with the actual writes from the server. Without this automatic database tracking, it would be very difficult to implement a correct Optimistic UI system.</p>
<h3 id="calling-method-from-method">Calling a Method from another Method</h3>

<p>Sometimes, you’ll want to call a Method from another Method. Perhaps you already have some functionality implemented and you want to add a wrapper that fills in some of the arguments automatically. This is a totally fine pattern, and Meteor does some nice things for you:</p>
<ol>
<li>Inside a client-side Method simulation, calling another Method doesn’t fire off an extra request to the server - the assumption is that the server-side implementation of the Method will do it. However, it does run the <em>simulation</em> of the called Method, so that the simulation on the client closely matches what will happen on the server.</li>
<li>Inside a Method execution on the server, calling another Method runs that Method as if it were called by the same client. That means the Method runs as usual, and the context - <code>userId</code>, <code>connection</code>, etc - are taken from the original Method call.</li>
</ol>
<h3 id="consistent-id-generation">Consistent ID generation and optimistic UI</h3>

<p>When you insert documents into Minimongo from the client-side simulation of a Method, the <code>_id</code> field of each document is a random string. When the Method call is executed on the server, the IDs are generated again before being inserted into the database. If it were implemented naively, it could mean that the IDs generated on the server are different, which would cause undesirable flickering and re-renders in the UI when the Method simulation was rolled back and replaced with the server data. But this is not the case in Meteor!</p>
<p>Each Meteor Method invocation shares a random generator seed with the client that called the Method, so any IDs generated by the client and server Methods are guaranteed to be the same. This means you can safely use the IDs generated on the client to do things while the Method is being sent to the server, and be confident that the IDs will be the same when the Method finishes. One case where this is particularly useful is if you want to create a new document in the database, then immediately redirect to a URL that contains that new document’s ID.</p>
<h3 id="retries">Method retries</h3>

<p>If you call a Method from the client, and the user’s Internet connection disconnects before the result is received, Meteor assumes that the Method didn’t actually run. When the connection is re-established, the Method call will be sent again. This means that, in certain situations, Methods can be sent more than once. This should only happen very rarely, but in the case where an extra Method call could have negative consequences it is worth putting in extra effort to ensure that Methods are idempotent - that is, calling them multiple times doesn’t result in additional changes to the database.</p>
<p>Many Method operations are idempotent by default. Inserts will throw an error if they happen twice because the generated ID will conflict. Removes on collections won’t do anything the second time, and most update operators like <code>$set</code> will have the same result if run again. The only places you need to worry about code running twice are MongoDB update operators that stack, like <code>$inc</code> and <code>$push</code>, and calls to external APIs.</p>
<h3 id="comparison-with-allow-deny">Historical comparison with allow/deny</h3>

<p>The Meteor core API includes an alternative to Methods for manipulating data from the client. Instead of explicitly defining Methods with specific arguments, you can instead call <code>insert</code>, <code>update</code>, and <code>remove</code> directly from the client and specify security rules with <a href="http://docs.meteor.com/#/full/allow" target="_blank" rel="external"><code>allow</code></a> and <a href="http://docs.meteor.com/#/full/deny" target="_blank" rel="external"><code>deny</code></a>. In the Meteor Guide, we are taking a strong position that this feature should be avoided and Methods used instead. Read more about the problems with allow/deny in the <a href="security.html#allow-deny">Security article</a>.</p>
<p>Historically, there have been some misconceptions about the features of Meteor Methods as compared with the allow/deny feature, including that it was more difficult to achieve Optimistic UI when using Methods. However, the client-side <code>insert</code>, <code>update</code>, and <code>remove</code> feature is actually implemented <em>on top of</em> Methods, so Methods are strictly more powerful. You get great default Optimistic UI just by defining your Method code on the client and the server, as described in the Method lifecycle section above.</p>

    </div>
  </div>

  <div class="pagination">
    <div class="content-wrapper">
      
      
        <a class="link primary prev"
          href="writing-npm-packages.html">
          <span class="icon-arrow-left-alt"></span>
          <span class="subtitle-pagination">Previous</span>
          Writing npm Packages
        </a>
      
      
    </div>
  </div>

  <div class="github">
    <a class="link tertiary " href="https://github.com/ourmeteor/guide-zh/tree/master/content/methods.md" target="_blank">
      <span class="icon-github"></span>Edit on GitHub</a>
  </div>

  
    <div class="discourse-comments-wrapper content-wrapper">
      <div id='discourse-comments'></div>
    </div>

    <script type="text/javascript">
      DiscourseEmbed = { discourseUrl: 'http://forums.meteor.com/',
                         topicId: 19662 };

      (function() {
        var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
        d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
      })();
    </script>
  
</div>

    <script src="/script/smooth-scroll.min.js"></script>
    <script src="/script/main.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

    <script>
      // nectar ninja
      (function(){
        var handle = '@meteorjs';
        var a = document.createElement('script');
        var m = document.getElementsByTagName('script')[0];
        a.async = 1;
        a.src = 'https://nectar.ninja/api/v1/' + handle.slice(1);
        m.parentNode.insertBefore(a, m);
      })();

     
      
        // Segment Tracking
        !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
        analytics.load("zQx6cQifkTU79E3L0XAnmrOXP2A5bC6r");
        analytics.page()
        }}();
      

      // search box
      

        ['desktop', 'mobile'].forEach(function(type) {
          var search = docsearch({
            apiKey: 'b123b42bb515f300dc09dc88f7695ec1',
            indexName: 'meteor_guide',
            inputSelector: '#' + type + '-search-input',
            autocompleteOptions: {
              dropdownMenuContainer: '.wrapper-' + type + '-search-results',
              debug: true
            }
          }).autocomplete;

          var sidebar = document.querySelector('.sidebar-content');
          search.on('autocomplete:opened', function() {
            sidebar.classList.add('searching');
          });
          search.on('autocomplete:closed', function() {
            sidebar.classList.remove('searching');
          });
          search.on('autocomplete:updated', function() {
            if (search.val() === '') {
              search.autocomplete.close();
            }
          });
        });
      

      
        var REDIRECTS = {
  "/using-packages.html": "atmosphere-vs-npm.html",
  "/using-packages.html#npm": "using-npm-packages.html",
  "/using-packages.html#client-npm": "using-npm-packages.html#client-npm",
  "/using-packages.html#installing-npm": "using-npm-packages.html#installing-npm",
  "/using-packages.html#using-npm": "using-npm-packages.html#using-npm",
  "/using-packages.html#npm-styles": "using-npm-packages.html#npm-styles",
  "/using-packages.html#npm-shrinkwrap": "using-npm-packages.html#npm-shrinkwrap",
  "/using-packages.html#atmosphere": "using-atmosphere-packages.html",
  "/using-packages.html#atmosphere-searching": "using-atmosphere-packages.html#atmosphere-searching",
  "/using-packages.html#atmosphere-naming": "using-atmosphere-packages.html#atmosphere-naming",
  "/using-packages.html#installing-atmosphere": "using-atmosphere-packages.html#installing-atmosphere",
  "/using-packages.html#using-atmosphere": "using-atmosphere-packages.html#using-atmosphere",
  "/using-packages.html#importing-atmosphere-styles": "using-atmosphere-packages.html#importing-atmosphere-styles",
  "/using-packages.html#peer-npm-dependencies": "using-atmosphere-packages.html#peer-npm-dependencies",
  "/using-packages.html#package-namespacing": "using-atmosphere-packages.html#package-namespacing",
  "/using-packages.html#async-callbacks": "using-npm-packages.html#async-callbacks",
  "/using-packages.html#bind-environment": "using-npm-packages.html#bind-environment",
  "/using-packages.html#wrap-async": "using-npm-packages.html#wrap-async",
  "/using-packages.html#promises": "using-npm-packages.html#promises",
  "/using-packages.html#overriding-packages": "writing-npm-packages.html#overriding-npm-packages",
  "/using-packages.html#npm-overriding": "writing-npm-packages.html#overriding-npm-packages",
  "/using-packages.html#atmosphere-overriding": "writing-atmosphere-packages.html#overriding-atmosphere-packages",
  "/using-packages.html#npm-shrinkpack": "using-npm-packages.html#npm-shrinkpack",
  "/writing-packages.html": "writing-atmosphere-packages.html",
  "/writing-packages.html#npm-vs-atmosphere": "atmosphere-vs-npm.html",
  "/writing-packages.html#creating-npm": "writing-npm-packages.html",
  "/writing-packages.html#including-in-app": "writing-npm-packages.html#including-in-app",
  "/writing-packages.html#publishing-npm": "writing--packages.html#publishing-npm",
  "/writing-packages.html#creating": "writing-atmosphere-packages.html",
  "/writing-packages.html#adding-files": "writing-atmosphere-packages.html#adding-files",
  "/writing-packages.html#adding-javascript": "writing-atmosphere-packages.html#adding-javascript",
  "/writing-packages.html#adding-css": "writing-atmosphere-packages.html#adding-css",
  "/writing-packages.html#adding-style": "writing-atmosphere-packages.html#adding-style",
  "/writing-packages.html#adding-assests": "writing-atmosphere-packages.html#adding-assets",
  "/writing-packages.html#exporting": "writing-atmosphere-packages.html#exporting",
  "/writing-packages.html#dependencies": "writing-atmosphere-packages.html#dependencies",
  "/writing-packages.html#atmosphere-dependencies": "writing-atmosphere--packages.html#atmosphere-dependencies",
  "/writing-packages.html#meteor-version-dependencies": "writing-atmosphere-packages.html#meteor-version-dependencies",
  "/writing-packages.html#version-constraints": "writing-atmosphere-packages.html#version-constraints",
  "/writing-packages.html#npm-dependencies": "writing-atmosphere-packages.html#npm-dependencies",
  "/writing-packages.html#peer-npm-dependencies": "writing-atmosphere-packages.html#peer-npm-dependencies",
  "/writing-packages.html#cordova-plugins": "writing-atmosphere-packages.html#cordova-plugins",
  "/writing-packages.html#testing": "writing-atmosphere-packages.html#testing",
  "/writing-packages.html#testing-with-peer-dependencies": "writing-atmosphere-packages.html#testing-with-peer-dependencies",
  "/writing-packages.html#local-vs-published": "writing-atmosphere-packages.html#local-vs-published",
  "/writing-packages.html#build-plugins": "build-tool.html#build-plugins",
  "/writing-packages.html#types-of-build-plugins": "build-tool.html#types-of-build-plugins",
  "/writing-packages.html#writing-build-plugins": "build-tool.html#writing-build-plugins",
  "/writing-packages.html#caching-build-plugins": "build-tool.html#caching-build-plugins",
  "/testing.html#simple-unit-test": "testing.html#simple-blaze-unit-test"
};

        function redirect() {
          // Support redirects of the form /path#hash
          var locationKey = location.pathname + location.hash;
          if (REDIRECTS[locationKey]) {
            location.replace(location.origin + '/' + REDIRECTS[locationKey]);
          }

          // Support redirects of the form #hash (works for any path)
          var hashKey = location.hash;
          if (REDIRECTS[hashKey]) {
            location.replace(location.origin + '/' + REDIRECTS[hashKey]);
          }
        }

        // Redirect now
        redirect();

        // Redirect on hash change
        window.onhashchange = redirect;
      
    </script>
  </body>
</html>
